<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gemini-Hack-Manim</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');

      :root {
        color-scheme: dark;
        --bg: #0b0d12;
        --panel: #14171d;
        --panel-2: #1a1f26;
        --panel-3: #0f131a;
        --text: #e6e9ef;
        --muted: #9aa4b2;
        --accent: #6aa9ff;
        --accent-2: #22c55e;
        --border: #242a33;
        --tab: #151a22;
        --danger: #ef4444;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: 'IBM Plex Sans', sans-serif;
        background: radial-gradient(circle at top, #111620 0%, #0b0d12 40%, #0a0c10 100%);
        color: var(--text);
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: #0c0f14;
        border-bottom: 1px solid var(--border);
      }
      .window-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .dot {
        width: 12px;
        height: 12px;
        border-radius: 999px;
        background: #ef4444;
      }
      .dot.yellow { background: #f59e0b; }
      .dot.green { background: #22c55e; }
      .topbar-title {
        font-weight: 600;
        color: #d7dce5;
        letter-spacing: 0.4px;
      }
      .topbar-actions {
        display: flex;
        gap: 8px;
      }
      .icon-btn {
        background: #0f141d;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
      }
      .icon-btn.primary {
        background: var(--accent);
        color: #0b0f14;
        border: none;
        font-weight: 700;
      }

      .layout {
        display: grid;
        grid-template-columns: 280px 6px 1fr 6px 360px;
        grid-template-rows: 1fr;
        height: calc(100vh - 48px);
        gap: 0;
      }

      .splitter {
        background: #0f141d;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        cursor: col-resize;
      }
      .splitter.hidden { display: none; }

      .panel {
        background: var(--panel);
        border-right: 1px solid var(--border);
        border-left: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .panel-header {
        padding: 10px 12px;
        font-weight: 600;
        border-bottom: 1px solid var(--border);
        background: var(--panel-2);
      }
      .panel-body {
        padding: 10px 12px;
        overflow: auto;
      }

      .tabs {
        display: flex;
        gap: 6px;
        padding: 8px;
        background: var(--panel-2);
        border-bottom: 1px solid var(--border);
      }
      .tab {
        padding: 6px 12px;
        border-radius: 8px;
        background: var(--tab);
        border: 1px solid var(--border);
        font-size: 12px;
        cursor: pointer;
        color: var(--muted);
      }
      .tab.active {
        background: #1c2430;
        border-color: var(--accent);
        color: var(--accent);
      }

      .tab-panels {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .tab-panel {
        display: none;
        padding: 12px;
        overflow: auto;
        flex: 1;
      }
      .tab-panel.active { display: block; }

      .tree {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 12px;
        display: grid;
        gap: 6px;
      }
      .tree summary { cursor: pointer; color: #93c5fd; }
      .tree details { padding-left: 12px; }
      .tree .tree-file {
        color: #cbd5f5;
        padding-left: 12px;
        cursor: grab;
      }
      .tree .tree-file:hover { color: var(--accent); }

      .section-title {
        margin-top: 12px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--muted);
      }

      label {
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
      }
      input, select, textarea, button {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--panel-3);
        color: var(--text);
        font-family: inherit;
      }
      textarea { min-height: 90px; }
      button {
        background: var(--accent);
        color: #0b1220;
        font-weight: 700;
        border: none;
        cursor: pointer;
      }
      button.secondary { background: #1f2937; color: var(--text); }
      button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
      button.danger { background: #3f1d1d; color: #fecaca; border: 1px solid #7f1d1d; }

      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .row.small { grid-template-columns: 1fr auto auto; align-items: center; }
      .muted { color: var(--muted); font-size: 12px; }

      .workspace { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }

      .canvas-grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 12px; }
      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--panel-2);
        padding: 12px;
      }

      .preview-shell {
        width: 100%;
        aspect-ratio: var(--preview-aspect, 9 / 16);
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .preview-shell video { width: 100%; height: 100%; object-fit: contain; }

      .timeline-card { display: grid; gap: 12px; }
      .timeline-ruler {
        height: 24px;
        background: repeating-linear-gradient(
          90deg,
          rgba(255,255,255,0.08),
          rgba(255,255,255,0.08) 1px,
          transparent 1px,
          transparent 40px
        );
        border-radius: 6px;
        border: 1px solid var(--border);
      }
      .timeline-track {
        display: flex;
        gap: 6px;
        align-items: stretch;
      }
      .timeline-block {
        flex: 1;
        min-width: 60px;
        background: #0b1220;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        display: grid;
        gap: 4px;
      }
      .timeline-block.dragging { opacity: 0.5; }
      .timeline-block-header { font-size: 11px; color: var(--muted); }
      .timeline-block input { font-size: 11px; padding: 4px; }

      .terminal {
        border-top: 1px solid var(--border);
        background: #0b1119;
        padding: 10px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 12px;
      }
      .terminal.hidden { display: none; }
      .terminal pre { white-space: pre-wrap; margin: 0; color: #86efac; }

      .chat {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 10px;
      }
      .chat-messages { flex: 1; overflow: auto; display: grid; gap: 10px; }
      .bubble {
        background: #0b1220;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
      }
      .bubble.user { border-left: 3px solid var(--accent); }
      .bubble.agent { border-left: 3px solid var(--accent-2); }
      .bubble-title { font-weight: 600; font-size: 12px; color: var(--muted); }

      .agent-steps { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
      .agent-step {
        background: #0b1220;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        font-size: 11px;
        text-align: center;
      }
      .agent-step.active { border-color: var(--accent); color: var(--accent); }
      .agent-step.done { border-color: var(--accent-2); color: var(--accent-2); }
      .agent-step.error { border-color: var(--danger); color: var(--danger); }

      .context-block summary {
        cursor: pointer;
        color: var(--muted);
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .context-grid { display: grid; gap: 8px; margin-top: 8px; }

      .hidden { display: none !important; }
      .drop-target { outline: 2px dashed var(--accent); }

      .settings-drawer {
        position: fixed;
        top: 48px;
        right: 0;
        width: 360px;
        height: calc(100vh - 48px);
        background: var(--panel);
        border-left: 1px solid var(--border);
        box-shadow: -20px 0 40px rgba(0,0,0,0.4);
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        transform: translateX(100%);
        transition: transform 0.2s ease;
        z-index: 20;
      }
      .settings-drawer.open { transform: translateX(0); }

      @media (max-width: 1200px) {
        .layout { grid-template-columns: 1fr; grid-template-rows: auto; height: auto; }
        .splitter { display: none; }
        .canvas-grid { grid-template-columns: 1fr; }
        .settings-drawer { width: 100%; }
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="window-controls">
        <span class="dot"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
      </div>
      <div class="topbar-title">Gemini-Hack-Manim</div>
      <div class="topbar-actions">
        <button id="backBtn" class="icon-btn">Back</button>
        <button id="toggleLeft" class="icon-btn">Explorer</button>
        <button id="toggleRight" class="icon-btn">Chat</button>
        <button id="toggleTerminal" class="icon-btn">Terminal</button>
        <button id="openSettings" class="icon-btn primary">Settings</button>
      </div>
    </div>

    <div class="layout" id="layoutRoot">
      <aside class="panel" id="leftPanel">
        <div class="panel-header">Explorer</div>
        <div class="panel-body">
          <div class="section-title">Job</div>
          <div class="muted">Job ID</div>
          <div id="jobId" style="margin-bottom:8px;">—</div>
          <div class="tree" id="jobFileList"></div>

          <div class="section-title">Workspace</div>
          <div class="row small" style="margin-top:8px;">
            <input id="newPath" placeholder="folder/file.md" />
            <button id="createFolder" class="ghost">+ Folder</button>
            <button id="createFile" class="ghost">+ File</button>
          </div>
          <div class="muted" id="fileStatus" style="margin-top:6px;">Ready.</div>
          <div class="tree" id="workspaceTree" style="margin-top:8px;"></div>
        </div>
      </aside>

      <div class="splitter" id="splitterLeft"></div>

      <main class="panel workspace">
        <div class="tabs">
          <button class="tab active" data-tab="canvas">Canvas</button>
          <button class="tab" data-tab="timeline">Timeline</button>
          <button class="tab" data-tab="code">Code</button>
        </div>

        <div class="tab-panels">
          <section class="tab-panel active" data-tab="canvas">
            <div class="canvas-grid">
              <div class="card">
                <label for="templateSelect">Template</label>
                <select id="templateSelect"></select>

                <label for="templateDescription" style="margin-top:8px;">Template description</label>
                <textarea id="templateDescription" disabled></textarea>

                <div class="row" style="margin-top:8px;">
                  <div>
                    <label for="imagePrompt">Image prompt</label>
                    <input id="imagePrompt" placeholder="Scientist walking in a park" />
                  </div>
                  <div>
                    <label for="imageMode">Image placement</label>
                    <select id="imageMode">
                      <option value="background">Background</option>
                      <option value="foreground">Foreground</option>
                      <option value="both">Both</option>
                    </select>
                  </div>
                </div>

                <div class="row" style="margin-top:8px;">
                  <div>
                    <label for="includeImages">Include images</label>
                    <select id="includeImages">
                      <option value="true">Yes</option>
                      <option value="false">No</option>
                    </select>
                  </div>
                  <div>
                    <label for="aspect">Aspect ratio</label>
                    <select id="aspect">
                      <option value="9:16">9:16</option>
                      <option value="16:9">16:9</option>
                      <option value="1:1">1:1</option>
                    </select>
                  </div>
                </div>

                <details style="margin-top:10px;">
                  <summary>Advanced creative controls</summary>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="audience">Audience</label>
                      <select id="audience">
                        <option value="general">General</option>
                        <option value="high school">High school</option>
                        <option value="undergrad">Undergrad</option>
                        <option value="expert">Expert</option>
                      </select>
                    </div>
                    <div>
                      <label for="tone">Tone</label>
                      <select id="tone">
                        <option value="epic">Epic</option>
                        <option value="calm">Calm</option>
                        <option value="playful">Playful</option>
                        <option value="serious">Serious</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="style">Style</label>
                      <select id="style">
                        <option value="cinematic">Cinematic</option>
                        <option value="clean">Clean</option>
                        <option value="chalkboard">Chalkboard</option>
                        <option value="neon">Neon</option>
                      </select>
                    </div>
                    <div>
                      <label for="pace">Pace</label>
                      <select id="pace">
                        <option value="medium">Medium</option>
                        <option value="slow">Slow</option>
                        <option value="fast">Fast</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="palette">Color palette</label>
                      <select id="palette">
                        <option value="cool">Cool</option>
                        <option value="warm">Warm</option>
                        <option value="neon">Neon</option>
                        <option value="monochrome">Monochrome</option>
                      </select>
                    </div>
                    <div>
                      <label for="quality">Render quality</label>
                      <select id="quality">
                        <option value="pql">Low</option>
                        <option value="pqm">Medium</option>
                        <option value="pqh">High</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="targetSeconds">Target seconds</label>
                      <input id="targetSeconds" placeholder="Leave blank" />
                    </div>
                    <div>
                      <label for="maxScenes">Max scenes</label>
                      <input id="maxScenes" placeholder="Leave blank" />
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="maxObjects">Max objects</label>
                      <input id="maxObjects" placeholder="Leave blank" />
                    </div>
                    <div>
                      <label for="directorBrief">Director brief</label>
                      <input id="directorBrief" placeholder="Use a strong hook" />
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="equations">Equations</label>
                      <select id="equations">
                        <option value="true">Include</option>
                        <option value="false">Exclude</option>
                      </select>
                    </div>
                    <div>
                      <label for="graphs">Graphs</label>
                      <select id="graphs">
                        <option value="true">Include</option>
                        <option value="false">Exclude</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="narration">Narration</label>
                      <select id="narration">
                        <option value="true">Include</option>
                        <option value="false">Exclude</option>
                      </select>
                    </div>
                    <div>
                      <label for="imageModelOverride">Image model override</label>
                      <select id="imageModelOverride">
                        <option value="">Default</option>
                        <option value="gemini-2.5-flash-image">gemini-2.5-flash-image (Nano Banana)</option>
                        <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview</option>
                      </select>
                    </div>
                  </div>
                </details>
              </div>

              <div class="card">
                <div class="muted" style="margin-bottom:6px;">Preview</div>
                <div class="preview-shell" id="previewSlot"></div>
                <div class="muted" style="margin-top:8px;">The video will appear here after render.</div>
              </div>
            </div>
          </section>

          <section class="tab-panel" data-tab="timeline">
            <div class="timeline-card">
              <div class="preview-shell" id="timelineVideoSlot"></div>
              <div>
                <div class="muted" id="timelineLabel">Timeline</div>
                <div class="timeline-ruler"></div>
                <div class="timeline-track" id="timelineTrack" style="margin-top:8px;"></div>
                <input id="timelineScrub" type="range" min="0" max="100" value="0" style="margin-top:8px;" />
              </div>
              <div class="row" style="margin-top:8px;">
                <button id="applyTimeline" class="secondary">Apply to plan</button>
                <button id="resetTimeline" class="ghost">Reset timeline</button>
              </div>
            </div>
          </section>

          <section class="tab-panel" data-tab="code">
            <div class="row" style="margin-bottom:8px;">
              <button id="renderCode" class="secondary">Render edited code</button>
              <button id="downloadVideo" class="secondary">Download video</button>
            </div>
            <label>Generated code</label>
            <textarea id="code" style="min-height:320px; font-family:'IBM Plex Mono', monospace;"></textarea>
          </section>
        </div>

        <div class="terminal" id="terminalPanel">
          <div class="muted">Terminal</div>
          <pre id="logs">Logs will appear here.</pre>
        </div>
      </main>

      <div class="splitter" id="splitterRight"></div>

      <aside class="panel" id="rightPanel">
        <div class="panel-header">Chat & Agent</div>
        <div class="panel-body chat">
          <div class="agent-steps" id="agentSteps">
            <div class="agent-step" data-step="plan">Plan</div>
            <div class="agent-step" data-step="approve">Approve</div>
            <div class="agent-step" data-step="code">Code</div>
            <div class="agent-step" data-step="render">Render</div>
          </div>

          <div class="chat-messages" id="chatMessages"></div>

          <details class="context-block">
            <summary>Context & Skills</summary>
            <div class="context-grid">
              <div>
                <label for="memoryTitle">Memory title</label>
                <input id="memoryTitle" placeholder="Photoelectric effect key idea" />
                <label for="memoryContent" style="margin-top:6px;">Memory content</label>
                <input id="memoryContent" placeholder="Threshold frequency depends on work function" />
                <button id="addMemory" style="margin-top:6px;">Add memory</button>
                <div class="tree" id="memoryList" style="margin-top:6px;"></div>
              </div>
              <div>
                <label for="skillName">Skill name</label>
                <input id="skillName" placeholder="Physics explainers" />
                <label for="skillContent" style="margin-top:6px;">Skill instructions</label>
                <input id="skillContent" placeholder="Always define variables on screen" />
                <button id="saveSkill" style="margin-top:6px;">Save skill</button>
                <label for="skillIdea" style="margin-top:6px;">Generate skill idea</label>
                <input id="skillIdea" placeholder="Visual storytelling tone" />
                <input id="skillGenerateName" placeholder="Skill name (optional)" style="margin-top:6px;" />
                <button id="generateSkill" class="secondary" style="margin-top:6px;">Generate skill</button>
                <div class="tree" id="skillList" style="margin-top:6px;"></div>
              </div>
            </div>
          </details>

          <label for="chatModel">Text model</label>
          <select id="chatModel">
            <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
            <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
            <option value="gemini-2.5-flash">gemini-2.5-flash</option>
            <option value="gemini-2.5-pro">gemini-2.5-pro</option>
          </select>
          <label for="chatInput" style="margin-top:8px;">Prompt</label>
          <textarea id="chatInput" placeholder="Make an animation of the photoelectric effect"></textarea>
          <button id="planBtn" style="margin-top:8px;">Create plan</button>
          <div class="muted" id="status">Ready.</div>
        </div>
      </aside>
    </div>

    <div class="settings-drawer" id="settingsDrawer">
      <div class="panel-header" style="border-radius: 10px;">Settings</div>
      <div class="panel-body" style="padding: 0;">
        <label for="settingsApiKey">Gemini API key</label>
        <input id="settingsApiKey" type="password" placeholder="Paste key" />
        <button id="settingsShowKey" class="ghost" style="margin-top:6px;">Show / Hide key</button>

        <label for="settingsTextModel" style="margin-top:10px;">Default text model</label>
        <select id="settingsTextModel">
          <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
          <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
          <option value="gemini-2.5-flash">gemini-2.5-flash</option>
          <option value="gemini-2.5-pro">gemini-2.5-pro</option>
        </select>

        <label for="settingsImageModel" style="margin-top:10px;">Default image model</label>
        <select id="settingsImageModel">
          <option value="gemini-2.5-flash-image">gemini-2.5-flash-image (Nano Banana)</option>
          <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview</option>
        </select>
        <div class="muted" style="margin-top:6px;">Nano Banana = gemini-2.5-flash-image</div>

        <label for="settingsManimPy" style="margin-top:10px;">Manim Python path</label>
        <input id="settingsManimPy" type="text" placeholder="python3" />

        <div class="row" style="margin-top:10px;">
          <button id="saveSettings">Save settings</button>
          <button id="runHealth" class="secondary">Check Manim</button>
        </div>
        <pre id="health" class="muted" style="margin-top:8px; white-space:pre-wrap;">No checks yet.</pre>
      </div>
    </div>

    <script>
      const jobFileListEl = document.getElementById('jobFileList');
      const jobIdEl = document.getElementById('jobId');
      const workspaceTreeEl = document.getElementById('workspaceTree');
      const newPathEl = document.getElementById('newPath');
      const createFolderBtn = document.getElementById('createFolder');
      const createFileBtn = document.getElementById('createFile');
      const fileStatusEl = document.getElementById('fileStatus');

      const templateSelectEl = document.getElementById('templateSelect');
      const templateDescriptionEl = document.getElementById('templateDescription');
      const imagePromptEl = document.getElementById('imagePrompt');
      const imageModeEl = document.getElementById('imageMode');
      const includeImagesEl = document.getElementById('includeImages');
      const aspectEl = document.getElementById('aspect');
      const audienceEl = document.getElementById('audience');
      const toneEl = document.getElementById('tone');
      const styleEl = document.getElementById('style');
      const paceEl = document.getElementById('pace');
      const paletteEl = document.getElementById('palette');
      const qualityEl = document.getElementById('quality');
      const targetSecondsEl = document.getElementById('targetSeconds');
      const maxScenesEl = document.getElementById('maxScenes');
      const maxObjectsEl = document.getElementById('maxObjects');
      const directorBriefEl = document.getElementById('directorBrief');
      const equationsEl = document.getElementById('equations');
      const graphsEl = document.getElementById('graphs');
      const narrationEl = document.getElementById('narration');
      const imageModelOverrideEl = document.getElementById('imageModelOverride');

      const memoryTitleEl = document.getElementById('memoryTitle');
      const memoryContentEl = document.getElementById('memoryContent');
      const addMemoryBtn = document.getElementById('addMemory');
      const memoryListEl = document.getElementById('memoryList');
      const skillNameEl = document.getElementById('skillName');
      const skillContentEl = document.getElementById('skillContent');
      const saveSkillBtn = document.getElementById('saveSkill');
      const skillIdeaEl = document.getElementById('skillIdea');
      const skillGenerateNameEl = document.getElementById('skillGenerateName');
      const generateSkillBtn = document.getElementById('generateSkill');
      const skillListEl = document.getElementById('skillList');

      const previewSlot = document.getElementById('previewSlot');
      const timelineVideoSlot = document.getElementById('timelineVideoSlot');
      const timelineTrackEl = document.getElementById('timelineTrack');
      const timelineLabelEl = document.getElementById('timelineLabel');
      const timelineScrubEl = document.getElementById('timelineScrub');
      const applyTimelineBtn = document.getElementById('applyTimeline');
      const resetTimelineBtn = document.getElementById('resetTimeline');
      const codeEl = document.getElementById('code');
      const renderCodeBtn = document.getElementById('renderCode');
      const downloadVideoBtn = document.getElementById('downloadVideo');
      const logsEl = document.getElementById('logs');
      const terminalPanel = document.getElementById('terminalPanel');

      window.addEventListener('error', (e) => {
        const msg = e?.error?.stack || e?.message || String(e);
        logsEl.textContent = `JS error:\\n${msg}`;
      });
      window.addEventListener('unhandledrejection', (e) => {
        const msg = e?.reason?.stack || e?.reason?.message || String(e?.reason || e);
        logsEl.textContent = `Unhandled promise rejection:\\n${msg}`;
      });

      const chatMessagesEl = document.getElementById('chatMessages');
      const chatInputEl = document.getElementById('chatInput');
      const chatModelEl = document.getElementById('chatModel');
      const planBtn = document.getElementById('planBtn');
      const statusEl = document.getElementById('status');
      const agentStepsEl = document.getElementById('agentSteps');

      const leftPanel = document.getElementById('leftPanel');
      const rightPanel = document.getElementById('rightPanel');
      const layoutRoot = document.getElementById('layoutRoot');
      const splitterLeft = document.getElementById('splitterLeft');
      const splitterRight = document.getElementById('splitterRight');

      const settingsDrawer = document.getElementById('settingsDrawer');
      const openSettingsBtn = document.getElementById('openSettings');
      const settingsApiKeyEl = document.getElementById('settingsApiKey');
      const settingsShowKeyBtn = document.getElementById('settingsShowKey');
      const settingsTextModelEl = document.getElementById('settingsTextModel');
      const settingsImageModelEl = document.getElementById('settingsImageModel');
      const settingsManimPyEl = document.getElementById('settingsManimPy');
      const saveSettingsBtn = document.getElementById('saveSettings');
      const runHealthBtn = document.getElementById('runHealth');
      const healthEl = document.getElementById('health');

      const videoEl = document.createElement('video');
      videoEl.controls = true;
      previewSlot.appendChild(videoEl);

      let lastPlanBox = null;
      let timelineState = [];
      let timelineMeta = { title: 'Scene Plan' };

      function attachVideo(slot) {
        if (videoEl.parentElement !== slot) {
          slot.appendChild(videoEl);
        }
      }

      function getLayoutSizes() {
        const stored = JSON.parse(localStorage.getItem('layoutSizes') || '{}');
        const leftNum = Number(stored.left);
        const rightNum = Number(stored.right);
        return {
          left: Number.isFinite(leftNum) ? leftNum : 280,
          right: Number.isFinite(rightNum) ? rightNum : 360,
        };
      }

      function saveLayoutSizes(left, right) {
        localStorage.setItem('layoutSizes', JSON.stringify({ left, right }));
      }

      function applyLayoutColumns() {
        const leftVisible = !leftPanel.classList.contains('hidden');
        const rightVisible = !rightPanel.classList.contains('hidden');
        const sizes = getLayoutSizes();
        splitterLeft.classList.toggle('hidden', !leftVisible);
        splitterRight.classList.toggle('hidden', !rightVisible);

        if (leftVisible && rightVisible) {
          layoutRoot.style.gridTemplateColumns = `${sizes.left}px 6px 1fr 6px ${sizes.right}px`;
        } else if (leftVisible && !rightVisible) {
          layoutRoot.style.gridTemplateColumns = `${sizes.left}px 6px 1fr`;
        } else if (!leftVisible && rightVisible) {
          layoutRoot.style.gridTemplateColumns = `1fr 6px ${sizes.right}px`;
        } else {
          layoutRoot.style.gridTemplateColumns = `1fr`;
        }
      }

      document.getElementById('toggleLeft').addEventListener('click', () => {
        leftPanel.classList.toggle('hidden');
        applyLayoutColumns();
      });
      document.getElementById('toggleRight').addEventListener('click', () => {
        rightPanel.classList.toggle('hidden');
        applyLayoutColumns();
      });
      document.getElementById('toggleTerminal').addEventListener('click', () => {
        terminalPanel.classList.toggle('hidden');
      });

      document.getElementById('backBtn').addEventListener('click', () => {
        currentJobId = null;
        jobIdEl.textContent = '—';
        jobFileListEl.innerHTML = '';
        codeEl.value = '';
        logsEl.textContent = 'Cleared.';
        statusEl.textContent = 'Ready.';
        chatMessagesEl.innerHTML = '';
        videoEl.removeAttribute('src');
        videoEl.load();
        timelineTrackEl.innerHTML = '';
        timelineState = [];
      });

      openSettingsBtn.addEventListener('click', () => {
        settingsDrawer.classList.toggle('open');
      });
      settingsShowKeyBtn.addEventListener('click', () => {
        const isHidden = settingsApiKeyEl.type === 'password';
        settingsApiKeyEl.type = isHidden ? 'text' : 'password';
      });

      const tabs = Array.from(document.querySelectorAll('.tab'));
      const panels = Array.from(document.querySelectorAll('.tab-panel'));
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const target = tab.dataset.tab;
          panels.forEach(p => p.classList.toggle('active', p.dataset.tab === target));
          if (target === 'timeline') {
            attachVideo(timelineVideoSlot);
          } else {
            attachVideo(previewSlot);
          }
        });
      });

      function initSplitter(splitter, side) {
        let startX = 0;
        let startLeft = 0;
        let startRight = 0;

        splitter.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startX = e.clientX;
          const sizes = getLayoutSizes();
          startLeft = Number(sizes.left) || 280;
          startRight = Number(sizes.right) || 360;
          const prevUserSelect = document.body.style.userSelect;
          const prevCursor = document.body.style.cursor;
          document.body.style.userSelect = 'none';
          document.body.style.cursor = 'col-resize';

          function onMove(ev) {
            const dx = ev.clientX - startX;
            if (side === 'left') {
              const next = Math.max(200, Math.min(480, startLeft + dx));
              saveLayoutSizes(next, startRight);
            } else {
              const next = Math.max(240, Math.min(520, startRight - dx));
              saveLayoutSizes(startLeft, next);
            }
            applyLayoutColumns();
          }

          function onUp() {
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onUp);
            document.body.style.userSelect = prevUserSelect;
            document.body.style.cursor = prevCursor;
          }

          window.addEventListener('mousemove', onMove);
          window.addEventListener('mouseup', onUp);
        });
      }
      initSplitter(splitterLeft, 'left');
      initSplitter(splitterRight, 'right');

      let templates = [];
      let currentJobId = null;
      let currentPlanText = null;

      function setPreviewAspect(ratio) {
        let val = '9 / 16';
        if (ratio === '16:9') val = '16 / 9';
        if (ratio === '1:1') val = '1 / 1';
        previewSlot.style.setProperty('--preview-aspect', val);
        timelineVideoSlot.style.setProperty('--preview-aspect', val);
      }

      function setStep(step, state) {
        const el = agentStepsEl.querySelector(`[data-step="${step}"]`);
        if (!el) return;
        el.classList.remove('active','done','error');
        if (state) el.classList.add(state);
      }
      function resetSteps() {
        ['plan','approve','code','render'].forEach(s => setStep(s, ''));
      }

      function addChat(role, title, content, extraNode) {
        const bubble = document.createElement('div');
        bubble.className = `bubble ${role}`;
        bubble.innerHTML = `<div class="bubble-title">${title}</div><div>${content}</div>`;
        if (extraNode) bubble.appendChild(extraNode);
        chatMessagesEl.appendChild(bubble);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      }

      function updateJobFiles(files) {
        jobFileListEl.innerHTML = '';
        if (!files || !files.length) {
          jobFileListEl.innerHTML = '<div class="muted">No files yet.</div>';
          return;
        }
        files.forEach(f => {
          const item = document.createElement('div');
          item.className = 'tree-file';
          item.textContent = f;
          jobFileListEl.appendChild(item);
        });
      }

      function renderTree(node, container) {
        if (!node) return;
        if (node.type === 'dir') {
          const details = document.createElement('details');
          details.open = true;
          const summary = document.createElement('summary');
          summary.textContent = node.name || 'folder';
          details.appendChild(summary);
          (node.children || []).forEach(child => renderTree(child, details));
          container.appendChild(details);
        } else {
          const item = document.createElement('div');
          item.className = 'tree-file';
          item.textContent = node.name;
          item.draggable = true;
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', node.path);
            e.dataTransfer.effectAllowed = 'copy';
          });
          container.appendChild(item);
        }
      }

      async function loadWorkspaceFiles() {
        const resp = await fetch('/api/files');
        const data = await resp.json();
        workspaceTreeEl.innerHTML = '';
        renderTree(data.tree, workspaceTreeEl);
      }

      async function createFolder() {
        const path = newPathEl.value.trim();
        if (!path) {
          fileStatusEl.textContent = 'Enter a path first (e.g. notes or notes/script.md).';
          return;
        }
        fileStatusEl.textContent = 'Creating folder...';
        let data = null;
        try {
          const resp = await fetch('/api/files/folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
          });
          data = await resp.json();
        } catch (e) {
          fileStatusEl.textContent = 'Failed to reach backend. Is the server running?';
          return;
        }
        if (!data.ok) {
          fileStatusEl.textContent = data.error || 'Failed to create folder.';
          return;
        }
        fileStatusEl.textContent = `Folder created: ${data.path}`;
        newPathEl.value = '';
        loadWorkspaceFiles();
      }

      async function createFile() {
        const path = newPathEl.value.trim();
        if (!path) {
          fileStatusEl.textContent = 'Enter a path first (e.g. notes/outline.md).';
          return;
        }
        fileStatusEl.textContent = 'Creating file...';
        let data = null;
        try {
          const resp = await fetch('/api/files/file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path, content: '' })
          });
          data = await resp.json();
        } catch (e) {
          fileStatusEl.textContent = 'Failed to reach backend. Is the server running?';
          return;
        }
        if (!data.ok) {
          fileStatusEl.textContent = data.error || 'Failed to create file.';
          return;
        }
        fileStatusEl.textContent = `File created: ${data.path}`;
        newPathEl.value = '';
        loadWorkspaceFiles();
      }

      chatInputEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        chatInputEl.classList.add('drop-target');
      });
      chatInputEl.addEventListener('dragleave', () => {
        chatInputEl.classList.remove('drop-target');
      });
      chatInputEl.addEventListener('drop', async (e) => {
        e.preventDefault();
        chatInputEl.classList.remove('drop-target');
        const path = e.dataTransfer.getData('text/plain');
        if (!path) return;
        const resp = await fetch(`/api/files/file?path=${encodeURIComponent(path)}`);
        const data = await resp.json();
        if (!data.ok) {
          statusEl.textContent = data.error || 'Failed to attach file.';
          return;
        }
        chatInputEl.value += `\n\n[File: ${data.path}]\n${data.content}\n`;
      });

      async function loadTemplates() {
        const resp = await fetch('/api/templates');
        const data = await resp.json();
        templates = data.templates || [];
        templateSelectEl.innerHTML = '';
        templates.forEach((t, idx) => {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = `${t.name} (${t.category})`;
          if (idx === 0) opt.selected = true;
          templateSelectEl.appendChild(opt);
        });
        if (templates[0]) applyTemplate(templates[0]);
      }

      function applyTemplate(tpl) {
        if (!tpl) return;
        templateDescriptionEl.value = tpl.description;
        if (tpl.example_prompt) chatInputEl.value = tpl.example_prompt;
        if (tpl.director_brief) directorBriefEl.value = tpl.director_brief;
        const d = tpl.defaults || {};
        if (d.audience) audienceEl.value = d.audience;
        if (d.tone) toneEl.value = d.tone;
        if (d.style) styleEl.value = d.style;
        if (d.pace) paceEl.value = d.pace;
        if (d.color_palette) paletteEl.value = d.color_palette;
        if (d.aspect_ratio) { aspectEl.value = d.aspect_ratio; setPreviewAspect(d.aspect_ratio); }
        if (d.quality) qualityEl.value = d.quality;
        if (typeof d.include_equations === 'boolean') equationsEl.value = d.include_equations ? 'true' : 'false';
        if (typeof d.include_graphs === 'boolean') graphsEl.value = d.include_graphs ? 'true' : 'false';
        if (typeof d.include_narration === 'boolean') narrationEl.value = d.include_narration ? 'true' : 'false';
        if (d.target_seconds) targetSecondsEl.value = d.target_seconds;
      }

      templateSelectEl.addEventListener('change', () => {
        const tpl = templates.find(t => t.id === templateSelectEl.value);
        applyTemplate(tpl);
      });

      async function loadSettings() {
        const resp = await fetch('/api/settings');
        const data = await resp.json();
        if (data.text_model) {
          settingsTextModelEl.value = data.text_model;
          chatModelEl.value = data.text_model;
        }
        if (data.image_model) settingsImageModelEl.value = data.image_model;
        if (data.manim_py) settingsManimPyEl.value = data.manim_py;
      }

      async function saveSettings() {
        const resp = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            api_key: settingsApiKeyEl.value || null,
            text_model: settingsTextModelEl.value || null,
            image_model: settingsImageModelEl.value || null,
            manim_py: settingsManimPyEl.value || null
          })
        });
        const data = await resp.json();
        if (data.ok) {
          statusEl.textContent = 'Settings saved.';
          settingsApiKeyEl.value = '';
          if (data.text_model) chatModelEl.value = data.text_model;
        }
      }

      async function runHealth() {
        healthEl.textContent = 'Checking...';
        let data = null;
        try {
          const resp = await fetch('/api/health');
          data = await resp.json();
        } catch (e) {
          healthEl.textContent = 'Failed to reach backend. Is the server running?';
          return;
        }
        const manimStatus = data.manim_ok ? 'OK' : 'Missing';
        const ffmpegStatus = data.ffmpeg_ok ? 'OK' : 'Missing';
        const py = data.manim_py || 'python3';
        const cands = (data.python_candidates || []).join(', ');
        const ffmpegPath = data.ffmpeg_path || '';
        const lines = [
          `Manim: ${manimStatus}`,
          `ffmpeg: ${ffmpegStatus}`,
          `python: ${py}`,
        ];
        if (data.manim_version) lines.push(data.manim_version);
        if (cands) lines.push(`python candidates: ${cands}`);
        if (ffmpegPath) lines.push(`ffmpeg path: ${ffmpegPath}`);
        if (!data.manim_ok) {
          lines.push('Fix: set Manim Python path to an env with Manim, or run: pip install manim');
        }
        if (!data.ffmpeg_ok) {
          lines.push('Fix (macOS): brew install ffmpeg');
        }
        healthEl.textContent = lines.join('\\n');
      }

      async function loadMemories() {
        const resp = await fetch('/api/memories');
        const data = await resp.json();
        memoryListEl.innerHTML = '';
        (data.memories || []).forEach(mem => {
          const row = document.createElement('div');
          row.className = 'tree-file';
          row.innerHTML = `<label><input type="checkbox" data-id="${mem.id}" /> ${mem.title}</label>`;
          memoryListEl.appendChild(row);
        });
      }

      async function addMemory() {
        await fetch('/api/memories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: memoryTitleEl.value, content: memoryContentEl.value })
        });
        memoryTitleEl.value = '';
        memoryContentEl.value = '';
        loadMemories();
      }

      function selectedMemoryIds() {
        return Array.from(memoryListEl.querySelectorAll('input[type="checkbox"]')).filter(cb => cb.checked).map(cb => cb.dataset.id);
      }

      async function loadSkills() {
        const resp = await fetch('/api/skills');
        const data = await resp.json();
        skillListEl.innerHTML = '';
        (data.skills || []).forEach(skill => {
          const row = document.createElement('div');
          row.className = 'tree-file';
          row.innerHTML = `<label><input type="checkbox" data-id="${skill.id}" /> ${skill.name}</label>`;
          skillListEl.appendChild(row);
        });
      }

      async function saveSkill() {
        await fetch('/api/skills', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: skillNameEl.value, content: skillContentEl.value })
        });
        skillNameEl.value = '';
        skillContentEl.value = '';
        loadSkills();
      }

      async function generateSkill() {
        await fetch('/api/skills/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idea: skillIdeaEl.value, name: skillGenerateNameEl.value })
        });
        skillIdeaEl.value = '';
        skillGenerateNameEl.value = '';
        loadSkills();
      }

      function selectedSkillIds() {
        return Array.from(skillListEl.querySelectorAll('input[type="checkbox"]')).filter(cb => cb.checked).map(cb => cb.dataset.id);
      }

      function renderTimeline() {
        timelineTrackEl.innerHTML = '';
        if (!timelineState.length) {
          timelineLabelEl.textContent = 'Timeline';
          return;
        }
        const total = timelineState.reduce((s, sc) => s + sc.seconds, 0);
        timelineLabelEl.textContent = `Total ${total}s • ${timelineState.length} scenes`;

        timelineState.forEach((scene, idx) => {
          const block = document.createElement('div');
          block.className = 'timeline-block';
          block.draggable = true;
          block.dataset.index = idx;
          block.style.flex = String(scene.seconds);

          const header = document.createElement('div');
          header.className = 'timeline-block-header';
          header.textContent = `Scene ${idx + 1}`;
          const input = document.createElement('input');
          input.type = 'number';
          input.min = 1;
          input.value = scene.seconds;
          input.addEventListener('change', () => {
            const val = Math.max(1, Number(input.value || 1));
            timelineState[idx].seconds = val;
            renderTimeline();
          });

          block.appendChild(header);
          block.appendChild(input);

          block.addEventListener('dragstart', (e) => {
            block.classList.add('dragging');
            e.dataTransfer.setData('text/plain', idx.toString());
          });
          block.addEventListener('dragend', () => {
            block.classList.remove('dragging');
          });
          block.addEventListener('dragover', (e) => {
            e.preventDefault();
          });
          block.addEventListener('drop', (e) => {
            e.preventDefault();
            const from = Number(e.dataTransfer.getData('text/plain'));
            const to = Number(block.dataset.index);
            if (Number.isNaN(from) || Number.isNaN(to) || from === to) return;
            const moved = timelineState.splice(from, 1)[0];
            timelineState.splice(to, 0, moved);
            renderTimeline();
          });

          timelineTrackEl.appendChild(block);
        });
      }

      function syncPlanFromTimeline() {
        if (!lastPlanBox || !timelineState.length) return;
        const total = timelineState.reduce((s, sc) => s + sc.seconds, 0);
        const plan = {
          title: timelineMeta.title || 'Scene Plan',
          total_seconds: total,
          scenes: timelineState.map((sc) => ({
            seconds: sc.seconds,
            goal: sc.goal || 'Updated scene',
            elements: sc.elements || [],
            actions: sc.actions || [],
            narration: sc.narration || ''
          }))
        };
        lastPlanBox.value = JSON.stringify(plan, null, 2);
        currentPlanText = lastPlanBox.value;
      }

      async function createPlan() {
        resetSteps();
        setStep('plan', 'active');
        const idea = chatInputEl.value.trim();
        if (!idea) return;
        addChat('user', 'You', idea);
        statusEl.textContent = 'Planning...';

        const resp = await fetch('/api/plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            idea,
            audience: audienceEl.value,
            tone: toneEl.value,
            style: styleEl.value,
            pace: paceEl.value,
            color_palette: paletteEl.value,
            include_equations: equationsEl.value === 'true',
            include_graphs: graphsEl.value === 'true',
            include_narration: narrationEl.value === 'true',
            target_seconds: targetSecondsEl.value ? Number(targetSecondsEl.value) : null,
            max_scenes: maxScenesEl.value ? Number(maxScenesEl.value) : null,
            max_objects: maxObjectsEl.value ? Number(maxObjectsEl.value) : null,
            aspect_ratio: aspectEl.value,
            director_brief: directorBriefEl.value || null,
            include_images: includeImagesEl.value === 'true',
            image_prompt: imagePromptEl.value || null,
            memory_ids: selectedMemoryIds(),
            skill_ids: selectedSkillIds(),
            model: chatModelEl.value || null
          })
        });
        const data = await resp.json();
        if (!data.ok) {
          statusEl.textContent = data.error || 'Plan failed.';
          setStep('plan', 'error');
          return;
        }
        currentJobId = data.job_id;
        currentPlanText = data.plan_text;
        jobIdEl.textContent = currentJobId;
        updateJobFiles(data.job_files);

        const planBox = document.createElement('textarea');
        planBox.style.width = '100%';
        planBox.style.minHeight = '180px';
        planBox.value = data.plan_text;
        lastPlanBox = planBox;

        const approveBtn = document.createElement('button');
        approveBtn.textContent = 'Approve & Render';
        approveBtn.style.marginTop = '8px';

        const wrapper = document.createElement('div');
        wrapper.appendChild(planBox);
        wrapper.appendChild(approveBtn);

        addChat('agent', 'Scene Plan (edit if needed)', '', wrapper);
        setStep('plan', 'done');
        setStep('approve', 'active');

        approveBtn.addEventListener('click', async () => {
          await approvePlan(planBox.value);
        });

        if (data.plan && data.plan.scenes) {
          timelineMeta.title = data.plan.title || 'Scene Plan';
          timelineState = data.plan.scenes.map(sc => ({
            seconds: sc.seconds || 3,
            goal: sc.goal,
            elements: sc.elements,
            actions: sc.actions,
            narration: sc.narration
          }));
          renderTimeline();
        }
      }

      async function approvePlan(planText) {
        if (!currentJobId) return;
        statusEl.textContent = 'Generating video...';
        setStep('approve', 'done');
        setStep('code', 'active');

        const resp = await fetch('/api/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            job_id: currentJobId,
            plan_text: planText,
            include_images: includeImagesEl.value === 'true',
            image_prompt: imagePromptEl.value || null,
            image_mode: imageModeEl.value,
            image_model: imageModelOverrideEl.value || null,
            quality: qualityEl.value,
            aspect_ratio: aspectEl.value,
            model: chatModelEl.value || null
          })
        });
        const data = await resp.json();
        if (!data.ok) {
          statusEl.textContent = data.error || 'Render failed.';
          setStep('code', 'error');
          setStep('render', 'error');
          return;
        }
        setStep('code', 'done');
        setStep('render', 'done');

        const src = '/' + data.video_path + '?t=' + Date.now();
        videoEl.src = src;
        videoEl.load();
        codeEl.value = data.code || '';
        updateJobFiles(data.job_files);
        logsEl.textContent = data.image_warning ? data.image_warning : 'Render complete.';

        if (data.plan && data.plan.scenes) {
          timelineMeta.title = data.plan.title || 'Scene Plan';
          timelineState = data.plan.scenes.map(sc => ({
            seconds: sc.seconds || 3,
            goal: sc.goal,
            elements: sc.elements,
            actions: sc.actions,
            narration: sc.narration
          }));
          renderTimeline();
        }

        addChat('agent', 'Render complete', `<a href="${src}" target="_blank">Open video</a>`);
      }

      renderCodeBtn.addEventListener('click', async () => {
        if (!codeEl.value.trim()) return;
        const resp = await fetch('/api/render-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: codeEl.value, quality: qualityEl.value })
        });
        const data = await resp.json();
        if (!data.ok) {
          statusEl.textContent = data.error || 'Render failed.';
          return;
        }
        const src = '/' + data.video_path + '?t=' + Date.now();
        videoEl.src = src;
        videoEl.load();
        updateJobFiles(data.job_files);
      });

      downloadVideoBtn.addEventListener('click', () => {
        if (!videoEl.src) return;
        window.open(videoEl.src, '_blank');
      });

      timelineScrubEl.addEventListener('input', () => {
        if (!videoEl.duration) return;
        const pct = Number(timelineScrubEl.value) / 100;
        videoEl.currentTime = pct * videoEl.duration;
      });
      videoEl.addEventListener('timeupdate', () => {
        if (!videoEl.duration) return;
        timelineScrubEl.value = Math.floor((videoEl.currentTime / videoEl.duration) * 100);
      });

      applyTimelineBtn.addEventListener('click', syncPlanFromTimeline);
      resetTimelineBtn.addEventListener('click', () => {
        timelineState = [];
        renderTimeline();
      });

      planBtn.addEventListener('click', createPlan);
      saveSettingsBtn.addEventListener('click', saveSettings);
      runHealthBtn.addEventListener('click', runHealth);
      addMemoryBtn.addEventListener('click', addMemory);
      saveSkillBtn.addEventListener('click', saveSkill);
      generateSkillBtn.addEventListener('click', generateSkill);
      aspectEl.addEventListener('change', () => setPreviewAspect(aspectEl.value));
      createFolderBtn.addEventListener('click', createFolder);
      createFileBtn.addEventListener('click', createFile);

      loadTemplates();
      loadSettings();
      loadMemories();
      loadSkills();
      loadWorkspaceFiles();
      setPreviewAspect(aspectEl.value);
      applyLayoutColumns();
    </script>
  </body>
</html>
