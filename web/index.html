<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gemini Manim Animator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <style>
      @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');

      :root {
        color-scheme: dark;
        --bg: #0b0d12;
        --panel: #14171d;
        --panel-2: #1a1f26;
        --panel-3: #0f131a;
        --text: #e6e9ef;
        --muted: #9aa4b2;
        --accent: #6aa9ff;
        --accent-2: #22c55e;
        --border: #242a33;
        --tab: #151a22;
        --danger: #ef4444;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: 'IBM Plex Sans', sans-serif;
        background: radial-gradient(circle at top, #111620 0%, #0b0d12 40%, #0a0c10 100%);
        color: var(--text);
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: #0c0f14;
        border-bottom: 1px solid var(--border);
      }
      .window-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        min-width: 80px;
      }
      .dot {
        width: 12px;
        height: 12px;
        border-radius: 999px;
        background: #ef4444;
      }
      .dot.yellow { background: #f59e0b; }
      .dot.green { background: #22c55e; }
      .topbar-title {
        font-weight: 600;
        color: #d7dce5;
        letter-spacing: 0.4px;
      }
      .topbar-actions {
        display: flex;
        gap: 8px;
      }
      .icon-btn {
        background: #0f141d;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 10px;
        font-size: 12px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .icon-btn svg { width: 16px; height: 16px; }
      .icon-btn.primary {
        background: var(--accent);
        color: #0b0f14;
        border: none;
        font-weight: 700;
      }
      .icon-btn.primary svg { stroke: #0b0f14; }

      .layout {
        display: grid;
        grid-template-columns: 280px 6px 1fr 6px 360px;
        grid-template-rows: 1fr;
        height: calc(100vh - 48px);
        gap: 0;
      }

      /* Pin items to specific columns so toggling widths never reflows to a new row. */
      #leftPanel { grid-column: 1; grid-row: 1; }
      #splitterLeft { grid-column: 2; grid-row: 1; }
      main.workspace { grid-column: 3; grid-row: 1; }
      #splitterRight { grid-column: 4; grid-row: 1; }
      #rightPanel { grid-column: 5; grid-row: 1; }

      .splitter {
        background: #0f141d;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        cursor: col-resize;
      }
      .splitter.hidden { display: none; }

      .panel {
        background: var(--panel);
        border-right: 1px solid var(--border);
        border-left: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .panel-header {
        padding: 10px 12px;
        font-weight: 600;
        border-bottom: 1px solid var(--border);
        background: var(--panel-2);
      }
      .panel-body {
        padding: 10px 12px;
        overflow: auto;
      }

      .tabs {
        display: flex;
        gap: 6px;
        padding: 8px;
        background: var(--panel-2);
        border-bottom: 1px solid var(--border);
      }
      .tab {
        padding: 6px 12px;
        border-radius: 8px;
        background: var(--tab);
        border: 1px solid var(--border);
        font-size: 12px;
        cursor: pointer;
        color: var(--muted);
      }
      .tab.active {
        background: #1c2430;
        border-color: var(--accent);
        color: var(--accent);
      }

      .tab-panels {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .tab-panel {
        display: none;
        padding: 12px;
        overflow: auto;
        flex: 1;
      }
      .tab-panel.active { display: block; }

      .tree {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 12px;
        display: grid;
        gap: 6px;
      }
      .tree summary { cursor: pointer; color: #93c5fd; }
      .tree details { padding-left: 12px; }
      .tree .tree-file {
        color: #cbd5f5;
        padding-left: 12px;
        cursor: grab;
      }
      .tree .tree-file:hover { color: var(--accent); }

      .section-title {
        margin-top: 12px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--muted);
      }

      label {
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
      }
      input, select, textarea, button {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--panel-3);
        color: var(--text);
        font-family: inherit;
      }
      textarea { min-height: 90px; }
      button {
        background: var(--accent);
        color: #0b1220;
        font-weight: 700;
        border: none;
        cursor: pointer;
      }
      button.secondary { background: #1f2937; color: var(--text); }
      button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }

      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .row.small { grid-template-columns: 1fr auto auto auto; align-items: center; }
      .muted { color: var(--muted); font-size: 12px; }
      code { font-family: 'IBM Plex Mono', monospace; font-size: 12px; }

      .workspace { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }

      .canvas-grid { display: grid; grid-template-columns: 1.05fr 0.95fr; gap: 12px; }
      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--panel-2);
        padding: 12px;
      }

      .preview-shell {
        width: 100%;
        aspect-ratio: var(--preview-aspect, 9 / 16);
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .preview-shell video { width: 100%; height: 100%; object-fit: contain; }

      .preview-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
        pointer-events: none;
      }
      .overlay-btn {
        pointer-events: auto;
        width: auto;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.18);
        background: rgba(12, 15, 20, 0.72);
        backdrop-filter: blur(10px);
        color: var(--text);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .overlay-btn svg { width: 16px; height: 16px; }

      .preview-wrap {
        position: relative;
      }

      .asset-tray {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .asset-slot {
        border: 1px dashed rgba(255,255,255,0.18);
        background: rgba(15, 19, 26, 0.65);
        border-radius: 12px;
        padding: 8px;
        min-height: 96px;
        display: grid;
        gap: 6px;
        align-content: start;
      }
      .asset-title { font-size: 11px; color: var(--muted); }
      .asset-thumb {
        height: 64px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0b0f14;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 11px;
      }
      .asset-thumb img { width: 100%; height: 100%; object-fit: cover; }
      .asset-thumb.draggable { cursor: grab; }

      .timeline-wrap { margin-top: 12px; }
      .timeline-ruler {
        position: relative;
        height: 26px;
        background: #0b1220;
        border-radius: 8px;
        border: 1px solid var(--border);
        overflow: hidden;
      }
      .timeline-ruler .tick {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 1px;
        background: rgba(255,255,255,0.10);
      }
      .timeline-ruler .tick.major {
        background: rgba(106,169,255,0.45);
      }
      .timeline-ruler .tick-label {
        position: absolute;
        top: 6px;
        transform: translateX(-50%);
        font-size: 10px;
        color: var(--muted);
        white-space: nowrap;
      }
      .timeline-track {
        display: flex;
        gap: 6px;
        align-items: stretch;
        margin-top: 8px;
      }
      .timeline-block {
        flex: 1;
        min-width: 64px;
        background: #0b1220;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px;
        display: grid;
        gap: 6px;
      }
      .timeline-block.dragging { opacity: 0.55; }
      .timeline-block-header {
        font-size: 11px;
        color: var(--muted);
        line-height: 1.2;
      }
      .timeline-block input { font-size: 11px; padding: 6px; }

      .terminal {
        border-top: 1px solid var(--border);
        background: #0b1119;
        padding: 10px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 12px;
      }
      .terminal.hidden { display: none; }
      .terminal pre { white-space: pre-wrap; margin: 0; color: #86efac; }

      .chat {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 10px;
      }
      .chat-messages { flex: 1; overflow: auto; display: grid; gap: 10px; }
      .bubble {
        background: #0b1220;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
      }
      .bubble.user { border-left: 3px solid var(--accent); }
      .bubble.agent { border-left: 3px solid var(--accent-2); }
      .bubble-title { font-weight: 600; font-size: 12px; color: var(--muted); }

      .agent-steps { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
      .agent-step {
        background: #0b1220;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px;
        font-size: 11px;
        text-align: center;
      }
      .agent-step.active { border-color: var(--accent); color: var(--accent); }
      .agent-step.done { border-color: var(--accent-2); color: var(--accent-2); }
      .agent-step.error { border-color: var(--danger); color: var(--danger); }

      .context-block summary {
        cursor: pointer;
        color: var(--muted);
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .context-grid { display: grid; gap: 8px; margin-top: 8px; }

      .drop-target { outline: 2px dashed var(--accent); }

      .hidden { display: none !important; }

      button:disabled, input:disabled, select:disabled, textarea:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .toolbar .spacer { flex: 1; }
      .btn-inline { width: auto; padding: 8px 10px; }

      pre.hljs {
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 12px;
        overflow: auto;
        max-height: 520px;
      }

      .settings-drawer {
        position: fixed;
        top: 48px;
        right: 0;
        width: 380px;
        height: calc(100vh - 48px);
        background: var(--panel);
        border-left: 1px solid var(--border);
        box-shadow: -20px 0 40px rgba(0,0,0,0.4);
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        transform: translateX(100%);
        transition: transform 0.2s ease;
        z-index: 20;
      }
      .settings-drawer.open { transform: translateX(0); }

      .drawer-section {
        border: 1px solid var(--border);
        background: var(--panel-2);
        border-radius: 12px;
        padding: 10px;
      }
      .drawer-title {
        font-weight: 700;
        font-size: 12px;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--muted);
        margin-bottom: 8px;
      }

      .toast {
        position: fixed;
        bottom: 14px;
        right: 14px;
        max-width: 420px;
        background: rgba(15, 20, 29, 0.95);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 12px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        z-index: 40;
      }
      .toast.ok { border-color: rgba(34, 197, 94, 0.6); }
      .toast.err { border-color: rgba(239, 68, 68, 0.6); }

      @media (max-width: 1200px) {
        .layout { grid-template-columns: 1fr; grid-template-rows: auto; height: auto; }
        /* Undo column pinning on smaller viewports to avoid implicit off-screen columns. */
        #leftPanel, #splitterLeft, main.workspace, #splitterRight, #rightPanel { grid-column: 1 !important; grid-row: auto !important; }
        .splitter { display: none !important; }
        .canvas-grid { grid-template-columns: 1fr; }
        .settings-drawer { width: 100%; }
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="window-controls">
        <span class="dot"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
      </div>
      <div class="topbar-title">Gemini Manim Animator</div>
      <div class="topbar-actions">
        <button id="backBtn" class="icon-btn" title="Back" aria-label="Back" data-tip="Back">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <button id="toggleLeft" class="icon-btn" title="Explorer" aria-label="Explorer" data-tip="Explorer">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h6l2 2h10v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M3 7V5a2 2 0 0 1 2-2h4l2 2"/></svg>
        </button>
        <button id="toggleRight" class="icon-btn" title="Chat" aria-label="Chat" data-tip="Chat">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
        </button>
        <button id="toggleTerminal" class="icon-btn" title="Terminal" aria-label="Terminal" data-tip="Terminal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17l6-5-6-5"/><path d="M12 19h8"/></svg>
        </button>
        <button id="openSettings" class="icon-btn primary" title="Settings" aria-label="Settings" data-tip="Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.8 1.8 0 0 0 .36 1.98l.03.03a2.2 2.2 0 0 1-1.56 3.75 2.2 2.2 0 0 1-1.56-.65l-.03-.03a1.8 1.8 0 0 0-1.98-.36 1.8 1.8 0 0 0-1.08 1.65V22a2.2 2.2 0 0 1-4.4 0v-.04a1.8 1.8 0 0 0-1.08-1.65 1.8 1.8 0 0 0-1.98.36l-.03.03a2.2 2.2 0 0 1-3.12 0 2.2 2.2 0 0 1 0-3.12l.03-.03A1.8 1.8 0 0 0 4.6 15a1.8 1.8 0 0 0-1.65-1.08H2.9a2.2 2.2 0 0 1 0-4.4h.04A1.8 1.8 0 0 0 4.6 8.44a1.8 1.8 0 0 0-.36-1.98l-.03-.03a2.2 2.2 0 0 1 3.12-3.12l.03.03A1.8 1.8 0 0 0 9.34 3.7 1.8 1.8 0 0 0 10.42 2.05V2a2.2 2.2 0 0 1 4.4 0v.04a1.8 1.8 0 0 0 1.08 1.65 1.8 1.8 0 0 0 1.98-.36l.03-.03a2.2 2.2 0 0 1 3.12 3.12l-.03.03a1.8 1.8 0 0 0-.36 1.98 1.8 1.8 0 0 0 1.65 1.08H22a2.2 2.2 0 0 1 0 4.4h-.04A1.8 1.8 0 0 0 19.4 15z"/></svg>
        </button>
      </div>
    </div>

    <div class="layout" id="layoutRoot">
      <aside class="panel" id="leftPanel">
        <div class="panel-header">Explorer</div>
        <div class="panel-body">
          <div class="section-title">Job</div>
          <div class="muted">Job ID</div>
          <div id="jobId" style="margin-bottom:8px;">—</div>
          <div class="tree" id="jobFileList"></div>

          <div class="section-title">Workspace</div>
          <div class="row small" style="margin-top:8px;">
            <input id="newPath" placeholder="notes/outline.md" />
            <button id="applyRename" class="ghost hidden" title="Apply rename" aria-label="Apply rename">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
            </button>
            <button id="createFolder" class="ghost" title="Create folder">+ Folder</button>
            <button id="createFile" class="ghost" title="Create file">+ File</button>
          </div>
          <div class="muted" id="fileStatus" style="margin-top:6px;">Tip: type a path, then click + Folder or + File.</div>
          <div class="tree" id="workspaceTree" style="margin-top:8px;"></div>
        </div>
      </aside>

      <div class="splitter" id="splitterLeft"></div>

      <main class="panel workspace">
        <div class="tabs">
          <button class="tab active" data-tab="canvas">Canvas</button>
          <button class="tab" data-tab="code">Code</button>
        </div>

        <div class="tab-panels">
          <section class="tab-panel active" data-tab="canvas">
            <div class="canvas-grid">
              <div class="card">
                <label for="templateSelect">Template</label>
                <select id="templateSelect"></select>

                <label for="templateDescription" style="margin-top:8px;">Template description</label>
                <textarea id="templateDescription" disabled></textarea>

                <div class="row" style="margin-top:8px;">
                  <div>
                    <label for="imagePrompt">Image prompt</label>
                    <input id="imagePrompt" placeholder="Scientist walking in a park" />
                  </div>
                  <div>
                    <label for="imageMode">Image placement</label>
                    <select id="imageMode">
                      <option value="background">Background</option>
                      <option value="foreground">Foreground</option>
                      <option value="both">Both</option>
                    </select>
                  </div>
                </div>

                <div class="asset-tray">
                  <div class="asset-slot">
                    <div class="asset-title">Background preview (drag into a scene)</div>
                    <div class="asset-thumb" id="bgThumb">No image yet</div>
                  </div>
                  <div class="asset-slot">
                    <div class="asset-title">Foreground preview (drag into a scene)</div>
                    <div class="asset-thumb" id="fgThumb">No image yet</div>
                  </div>
                </div>

                <div class="row" style="margin-top:8px;">
                  <div>
                    <label for="includeImages">Include images</label>
                    <select id="includeImages">
                      <option value="true">Yes</option>
                      <option value="false">No</option>
                    </select>
                  </div>
                  <div>
                    <label for="aspect">Aspect ratio</label>
                    <select id="aspect">
                      <option value="9:16">9:16</option>
                      <option value="16:9">16:9</option>
                      <option value="1:1">1:1</option>
                    </select>
                  </div>
                </div>

                <details style="margin-top:10px;">
                  <summary>Advanced creative controls</summary>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="audience">Audience</label>
                      <select id="audience">
                        <option value="general">General</option>
                        <option value="high school">High school</option>
                        <option value="undergrad">Undergrad</option>
                        <option value="expert">Expert</option>
                      </select>
                    </div>
                    <div>
                      <label for="tone">Tone</label>
                      <select id="tone">
                        <option value="epic">Epic</option>
                        <option value="calm">Calm</option>
                        <option value="playful">Playful</option>
                        <option value="serious">Serious</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="style">Style</label>
                      <select id="style">
                        <option value="cinematic">Cinematic</option>
                        <option value="clean">Clean</option>
                        <option value="chalkboard">Chalkboard</option>
                        <option value="neon">Neon</option>
                      </select>
                    </div>
                    <div>
                      <label for="pace">Pace</label>
                      <select id="pace">
                        <option value="medium">Medium</option>
                        <option value="slow">Slow</option>
                        <option value="fast">Fast</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="palette">Color palette</label>
                      <select id="palette">
                        <option value="cool">Cool</option>
                        <option value="warm">Warm</option>
                        <option value="neon">Neon</option>
                        <option value="monochrome">Monochrome</option>
                      </select>
                    </div>
                    <div>
                      <label for="quality">Render quality</label>
                      <select id="quality">
                        <option value="pql">Low</option>
                        <option value="pqm">Medium</option>
                        <option value="pqh">High</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="targetSeconds">Target seconds</label>
                      <input id="targetSeconds" placeholder="Leave blank" />
                    </div>
                    <div>
                      <label for="maxScenes">Max scenes</label>
                      <input id="maxScenes" placeholder="Leave blank" />
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="maxObjects">Max objects</label>
                      <input id="maxObjects" placeholder="Leave blank" />
                    </div>
                    <div>
                      <label for="directorBrief">Director brief</label>
                      <input id="directorBrief" placeholder="Use a strong hook" />
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="equations">Equations</label>
                      <select id="equations">
                        <option value="true">Include</option>
                        <option value="false">Exclude</option>
                      </select>
                    </div>
                    <div>
                      <label for="graphs">Graphs</label>
                      <select id="graphs">
                        <option value="true">Include</option>
                        <option value="false">Exclude</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" style="margin-top:8px;">
                    <div>
                      <label for="narration">Narration</label>
                      <select id="narration">
                        <option value="true">Include</option>
                        <option value="false">Exclude</option>
                      </select>
                    </div>
                    <div>
                      <label for="imageModelOverride">Image model override</label>
                      <select id="imageModelOverride">
                        <option value="">Default</option>
                        <option value="gemini-2.5-flash-image">gemini-2.5-flash-image (Nano Banana)</option>
                        <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview</option>
                      </select>
                    </div>
                  </div>
                </details>
              </div>

              <div class="card">
                <div class="muted" style="margin-bottom:6px;">Preview</div>
                <div class="preview-wrap">
                  <div class="preview-shell" id="previewSlot"></div>
                  <div class="preview-overlay">
                    <button id="downloadBtn" class="overlay-btn" title="Download video" aria-label="Download video">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="M7 10l5 5 5-5"/><path d="M5 21h14"/></svg>
                      Download
                    </button>
                    <button id="shareBtn" class="overlay-btn" title="Share" aria-label="Share">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M16 6l-4-4-4 4"/><path d="M12 2v14"/></svg>
                      Share
                    </button>
                  </div>
                </div>

                <div class="timeline-wrap">
                  <div class="muted" id="timelineLabel">Timeline</div>
                  <div class="timeline-ruler" id="timelineRuler" style="margin-top:6px;"></div>
                  <div class="timeline-track" id="timelineTrack"></div>
                  <input id="timelineScrub" type="range" min="0" max="100" value="0" style="margin-top:8px;" />
                  <div class="row" style="margin-top:8px;">
                    <button id="applyTimeline" class="secondary">Apply to plan</button>
                    <button id="resetTimeline" class="ghost">Reset</button>
                  </div>
                </div>

                <div class="muted" style="margin-top:10px;">
                  Pro tip: type <code>/health</code>, <code>/settings</code>, <code>/attach notes/outline.md</code>, <code>/clear</code> in the prompt box.
                </div>
              </div>
            </div>
          </section>

          <section class="tab-panel" data-tab="code">
            <div class="toolbar">
              <div class="muted" id="editorLabel">Editor</div>
              <div class="spacer"></div>
              <button id="addSelection" class="ghost btn-inline" title="Add selected text to prompt (@reference)">@</button>
              <button id="saveFile" class="ghost btn-inline" disabled>Save file</button>
              <button id="renderCode" class="secondary btn-inline">Render code</button>
              <button id="downloadVideo" class="secondary btn-inline">Download video</button>
              <button id="toggleHighlight" class="ghost btn-inline" title="Toggle syntax highlighting">Highlight</button>
            </div>
            <textarea id="code" style="min-height:420px; font-family:'IBM Plex Mono', monospace;"></textarea>
            <pre id="codePrettyWrap" class="hljs hidden"><code id="codePretty" class="language-python"></code></pre>
          </section>
        </div>

        <div class="terminal hidden" id="terminalPanel">
          <div class="toolbar" style="margin:0 0 8px 0;">
            <div class="muted">Terminal</div>
            <div class="spacer"></div>
            <input id="termCmd" class="btn-inline" style="width: 320px;" placeholder="help | manim --version | ffmpeg -version | ls jobs" />
            <button id="termRun" class="ghost btn-inline" title="Run command">Run</button>
          </div>
          <pre id="logs">Logs will appear here.</pre>
        </div>
      </main>

      <div class="splitter" id="splitterRight"></div>

      <aside class="panel" id="rightPanel">
        <div class="panel-header">Chat & Agent</div>
        <div class="panel-body chat">
          <div class="agent-steps" id="agentSteps">
            <div class="agent-step" data-step="plan">Plan</div>
            <div class="agent-step" data-step="approve">Approve</div>
            <div class="agent-step" data-step="code">Code</div>
            <div class="agent-step" data-step="render">Render</div>
          </div>

          <div class="chat-messages" id="chatMessages"></div>

          <details class="context-block">
          <summary>Memory (Context) & Skills</summary>
          <div class="context-grid">
              <div>
                <label for="memoryTitle">Memory title</label>
                <input id="memoryTitle" placeholder="Key idea" />
                <label for="memoryContent" style="margin-top:6px;">Memory content</label>
                <input id="memoryContent" placeholder="Threshold frequency depends on work function" />
                <button id="addMemory" style="margin-top:6px;">Add memory</button>
                <div class="tree" id="memoryList" style="margin-top:6px;"></div>
              </div>
              <div>
                <label for="skillName">Skill name</label>
                <input id="skillName" placeholder="Physics explainers" />
                <label for="skillContent" style="margin-top:6px;">Skill instructions</label>
                <input id="skillContent" placeholder="Always define variables on screen" />
                <button id="saveSkill" style="margin-top:6px;">Save skill</button>
                <label for="skillIdea" style="margin-top:6px;">Generate skill idea</label>
                <input id="skillIdea" placeholder="Make a concise storyboard rule" />
                <input id="skillGenerateName" placeholder="Skill name (optional)" style="margin-top:6px;" />
                <button id="generateSkill" class="secondary" style="margin-top:6px;">Generate skill</button>
                <div class="tree" id="skillList" style="margin-top:6px;"></div>
              </div>
            </div>
          </details>

          <div class="muted">
            Tip: use <code>/</code> commands like <code>/health</code> and drag files into the prompt.
          </div>

          <label for="chatModel">Text model</label>
          <select id="chatModel">
            <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
            <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
            <option value="gemini-2.5-flash">gemini-2.5-flash</option>
            <option value="gemini-2.5-pro">gemini-2.5-pro</option>
          </select>

          <label for="chatInput" style="margin-top:8px;">Prompt</label>
          <textarea id="chatInput" placeholder="Make an animation of the photoelectric effect"></textarea>
          <button id="planBtn" style="margin-top:8px;">Create plan</button>
          <div class="muted" id="status">Ready.</div>
        </div>
      </aside>
    </div>

    <div class="settings-drawer" id="settingsDrawer">
      <div class="drawer-section">
        <div class="drawer-title">API & Models</div>
        <label for="settingsApiKey">Gemini API key</label>
        <input id="settingsApiKey" type="password" placeholder="Paste key" />
        <button id="settingsShowKey" class="ghost" style="margin-top:6px;">Show / Hide key</button>

        <label for="settingsTextModel" style="margin-top:10px;">Default text model</label>
        <select id="settingsTextModel">
          <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
          <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
          <option value="gemini-2.5-flash">gemini-2.5-flash</option>
          <option value="gemini-2.5-pro">gemini-2.5-pro</option>
        </select>

        <label for="settingsImageModel" style="margin-top:10px;">Default image model</label>
        <select id="settingsImageModel">
          <option value="gemini-2.5-flash-image">gemini-2.5-flash-image (Nano Banana)</option>
          <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview</option>
        </select>
        <div class="muted" style="margin-top:6px;">Nano Banana = <code>gemini-2.5-flash-image</code></div>
      </div>

      <div class="drawer-section">
        <div class="drawer-title">Rendering</div>
        <label for="settingsManimPy">Python executable for Manim</label>
        <input id="settingsManimPy" type="text" placeholder="python3" />

        <div class="muted" style="margin-top:6px;">
          This is the python executable used to run <code>python -m manim</code>. Leave blank to auto-detect.
          Outputs are saved under <code>work/jobs/&lt;job_id&gt;/out.mp4</code>.
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="saveSettings">Save</button>
          <button id="runHealth" class="secondary">Health</button>
        </div>
        <pre id="health" class="muted" style="margin-top:8px; white-space:pre-wrap;">No checks yet.</pre>
      </div>

      <div class="drawer-section">
        <div class="drawer-title">Layout</div>
        <div class="muted">If panels disappear or sizes feel broken, reset the layout.</div>
        <button id="resetLayout" class="secondary" style="margin-top:8px;">Reset layout</button>
      </div>

      <div class="drawer-section">
        <div class="drawer-title">Agent Structure</div>
        <div class="muted">This is a lightweight “agentic” control layer. It appends to your director brief.</div>
        <label for="rulesText" style="margin-top:8px;">Rules</label>
        <textarea id="rulesText" placeholder="Example: 1 concept per scene. Always label variables. Keep text centered."></textarea>
        <label for="subagentsText" style="margin-top:8px;">Subagents (optional)</label>
        <textarea id="subagentsText" placeholder="Example:\nDirector: creates storyboard\nAnimator: writes manim code\nQA: validates labels + spacing"></textarea>
      </div>

      <div class="drawer-section">
        <div class="drawer-title">Docs / Indexing (MVP)</div>
        <div class="muted">Paste a URL + notes/transcript. This gets injected into the plan prompt. (Auto-scraping is not implemented yet.)</div>
        <label for="sourceUrl" style="margin-top:8px;">Source link</label>
        <input id="sourceUrl" placeholder="https://..." />
        <label for="sourceNotes" style="margin-top:8px;">Notes / transcript</label>
        <textarea id="sourceNotes" placeholder="Paste transcript or key points here"></textarea>
        <button id="saveSource" class="secondary" style="margin-top:8px;">Save source</button>
        <pre id="sourceStatus" class="muted" style="margin-top:8px; white-space:pre-wrap;">No sources yet.</pre>
      </div>
    </div>

    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

    <script>
      const jobFileListEl = document.getElementById('jobFileList');
      const jobIdEl = document.getElementById('jobId');
      const workspaceTreeEl = document.getElementById('workspaceTree');
      const newPathEl = document.getElementById('newPath');
      const applyRenameBtn = document.getElementById('applyRename');
      const createFolderBtn = document.getElementById('createFolder');
      const createFileBtn = document.getElementById('createFile');
      const fileStatusEl = document.getElementById('fileStatus');

      const templateSelectEl = document.getElementById('templateSelect');
      const templateDescriptionEl = document.getElementById('templateDescription');
      const imagePromptEl = document.getElementById('imagePrompt');
      const imageModeEl = document.getElementById('imageMode');
      const includeImagesEl = document.getElementById('includeImages');
      const aspectEl = document.getElementById('aspect');
      const audienceEl = document.getElementById('audience');
      const toneEl = document.getElementById('tone');
      const styleEl = document.getElementById('style');
      const paceEl = document.getElementById('pace');
      const paletteEl = document.getElementById('palette');
      const qualityEl = document.getElementById('quality');
      const targetSecondsEl = document.getElementById('targetSeconds');
      const maxScenesEl = document.getElementById('maxScenes');
      const maxObjectsEl = document.getElementById('maxObjects');
      const directorBriefEl = document.getElementById('directorBrief');
      const equationsEl = document.getElementById('equations');
      const graphsEl = document.getElementById('graphs');
      const narrationEl = document.getElementById('narration');
      const imageModelOverrideEl = document.getElementById('imageModelOverride');

      const memoryTitleEl = document.getElementById('memoryTitle');
      const memoryContentEl = document.getElementById('memoryContent');
      const addMemoryBtn = document.getElementById('addMemory');
      const memoryListEl = document.getElementById('memoryList');
      const skillNameEl = document.getElementById('skillName');
      const skillContentEl = document.getElementById('skillContent');
      const saveSkillBtn = document.getElementById('saveSkill');
      const skillIdeaEl = document.getElementById('skillIdea');
      const skillGenerateNameEl = document.getElementById('skillGenerateName');
      const generateSkillBtn = document.getElementById('generateSkill');
      const skillListEl = document.getElementById('skillList');

      const bgThumbEl = document.getElementById('bgThumb');
      const fgThumbEl = document.getElementById('fgThumb');

      const previewSlot = document.getElementById('previewSlot');
      const downloadBtnEl = document.getElementById('downloadBtn');
      const shareBtnEl = document.getElementById('shareBtn');
      const timelineRulerEl = document.getElementById('timelineRuler');
      const timelineTrackEl = document.getElementById('timelineTrack');
      const timelineLabelEl = document.getElementById('timelineLabel');
      const timelineScrubEl = document.getElementById('timelineScrub');
      const applyTimelineBtn = document.getElementById('applyTimeline');
      const resetTimelineBtn = document.getElementById('resetTimeline');
      const codeEl = document.getElementById('code');
      const editorLabelEl = document.getElementById('editorLabel');
      const addSelectionBtn = document.getElementById('addSelection');
      const saveFileBtn = document.getElementById('saveFile');
      const renderCodeBtn = document.getElementById('renderCode');
      const downloadVideoBtn = document.getElementById('downloadVideo');
      const toggleHighlightBtn = document.getElementById('toggleHighlight');
      const codePrettyWrapEl = document.getElementById('codePrettyWrap');
      const codePrettyEl = document.getElementById('codePretty');
      const logsEl = document.getElementById('logs');
      const terminalPanel = document.getElementById('terminalPanel');
      const termCmdEl = document.getElementById('termCmd');
      const termRunEl = document.getElementById('termRun');
      const toastEl = document.getElementById('toast');
      let toastTimer = null;

      function showToast(message, kind = '') {
        if (!toastEl) return;
        toastEl.textContent = String(message || '');
        toastEl.classList.remove('ok', 'err', 'hidden');
        if (kind) toastEl.classList.add(kind);
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toastEl.classList.add('hidden');
        }, 2600);
      }

      window.addEventListener('error', (e) => {
        const msg = e?.error?.stack || e?.message || String(e);
        logsEl.textContent = `JS error:\n${msg}`;
      });
      window.addEventListener('unhandledrejection', (e) => {
        const msg = e?.reason?.stack || e?.reason?.message || String(e?.reason || e);
        logsEl.textContent = `Unhandled promise rejection:\n${msg}`;
      });

      const chatMessagesEl = document.getElementById('chatMessages');
      const chatInputEl = document.getElementById('chatInput');
      const chatModelEl = document.getElementById('chatModel');
      const planBtn = document.getElementById('planBtn');
      const statusEl = document.getElementById('status');
      const agentStepsEl = document.getElementById('agentSteps');

      const leftPanel = document.getElementById('leftPanel');
      const rightPanel = document.getElementById('rightPanel');
      const layoutRoot = document.getElementById('layoutRoot');
      const splitterLeft = document.getElementById('splitterLeft');
      const splitterRight = document.getElementById('splitterRight');

      const settingsDrawer = document.getElementById('settingsDrawer');
      const openSettingsBtn = document.getElementById('openSettings');
      const settingsApiKeyEl = document.getElementById('settingsApiKey');
      const settingsShowKeyBtn = document.getElementById('settingsShowKey');
      const settingsTextModelEl = document.getElementById('settingsTextModel');
      const settingsImageModelEl = document.getElementById('settingsImageModel');
      const settingsManimPyEl = document.getElementById('settingsManimPy');
      const saveSettingsBtn = document.getElementById('saveSettings');
      const runHealthBtn = document.getElementById('runHealth');
      const healthEl = document.getElementById('health');
      const resetLayoutBtn = document.getElementById('resetLayout');

      const rulesTextEl = document.getElementById('rulesText');
      const subagentsTextEl = document.getElementById('subagentsText');

      const sourceUrlEl = document.getElementById('sourceUrl');
      const sourceNotesEl = document.getElementById('sourceNotes');
      const saveSourceBtn = document.getElementById('saveSource');
      const sourceStatusEl = document.getElementById('sourceStatus');

      const videoEl = document.createElement('video');
      videoEl.controls = true;
      previewSlot.appendChild(videoEl);
      let lastVideoUrl = '';

      downloadBtnEl.addEventListener('click', () => {
        if (!lastVideoUrl) return;
        const a = document.createElement('a');
        a.href = lastVideoUrl;
        a.download = currentJobId ? `${currentJobId}.mp4` : 'out.mp4';
        document.body.appendChild(a);
        a.click();
        a.remove();
        showToast('Downloading video…', 'ok');
      });
      shareBtnEl.addEventListener('click', async () => {
        if (!lastVideoUrl) return;
        try {
          if (navigator.share) {
            await navigator.share({ title: 'Gemini Manim Animator', url: lastVideoUrl });
          } else if (navigator.clipboard) {
            await navigator.clipboard.writeText(lastVideoUrl);
            statusEl.textContent = 'Copied video link to clipboard.';
            showToast('Copied video link.', 'ok');
          } else {
            statusEl.textContent = 'Sharing not supported in this browser.';
            showToast('Sharing not supported in this browser.', 'err');
          }
        } catch (e) {
          statusEl.textContent = 'Share cancelled.';
          showToast('Share cancelled.', 'err');
        }
      });

      let templates = [];
      let currentJobId = null;
      let currentPlanText = null;
      let lastPlanBox = null;
      let timelineState = [];
      let timelineMeta = { title: 'Scene Plan' };
      let openFilePath = null;
      let pendingRenameFrom = null;
      let lastAssets = { background: '', foreground: '' };
      const mqNarrow = window.matchMedia('(max-width: 1200px)');

      function getSources() {
        try {
          return JSON.parse(localStorage.getItem('sources') || '[]');
        } catch {
          return [];
        }
      }
      function setSources(sources) {
        localStorage.setItem('sources', JSON.stringify(sources));
      }
      function renderSources() {
        const sources = getSources();
        if (!sources.length) {
          sourceStatusEl.textContent = 'No sources yet.';
          return;
        }
        sourceStatusEl.textContent = sources.map((s, i) => `${i + 1}. ${s.url || '(no url)'}\n${(s.notes || '').slice(0, 240)}${(s.notes || '').length > 240 ? '…' : ''}`).join('\n\n');
      }

      function clampNumber(n, min, max) {
        return Math.max(min, Math.min(max, n));
      }

      function getLayoutSizes() {
        let stored = {};
        try {
          stored = JSON.parse(localStorage.getItem('layoutSizes') || '{}');
        } catch {
          stored = {};
        }
        const leftNum = Number(stored.left);
        const rightNum = Number(stored.right);
        return {
          left: Number.isFinite(leftNum) ? clampNumber(leftNum, 220, 520) : 280,
          right: Number.isFinite(rightNum) ? clampNumber(rightNum, 260, 560) : 360,
        };
      }

      function saveLayoutSizes(left, right) {
        localStorage.setItem('layoutSizes', JSON.stringify({ left, right }));
      }

      function applyLayoutColumns() {
        if (mqNarrow.matches) {
          // Let the CSS media query control the stack layout (no inline override).
          layoutRoot.style.removeProperty('grid-template-columns');
          splitterLeft.classList.add('hidden');
          splitterRight.classList.add('hidden');
          return;
        }
        const leftVisible = !leftPanel.classList.contains('hidden');
        const rightVisible = !rightPanel.classList.contains('hidden');
        const sizes = getLayoutSizes();
        const leftW = leftVisible ? sizes.left : 0;
        const rightW = rightVisible ? sizes.right : 0;
        const splitL = leftVisible ? 6 : 0;
        const splitR = rightVisible ? 6 : 0;
        splitterLeft.classList.toggle('hidden', !leftVisible);
        splitterRight.classList.toggle('hidden', !rightVisible);
        layoutRoot.style.gridTemplateColumns = `${leftW}px ${splitL}px 1fr ${splitR}px ${rightW}px`;
      }

      function resetLayout() {
        try { localStorage.removeItem('layoutSizes'); } catch {}
        leftPanel.classList.remove('hidden');
        rightPanel.classList.remove('hidden');
        applyLayoutColumns();
        showToast('Layout reset.', 'ok');
      }

      document.getElementById('toggleLeft').addEventListener('click', () => {
        leftPanel.classList.toggle('hidden');
        applyLayoutColumns();
      });
      document.getElementById('toggleRight').addEventListener('click', () => {
        rightPanel.classList.toggle('hidden');
        applyLayoutColumns();
      });
      document.getElementById('toggleTerminal').addEventListener('click', () => {
        const isHidden = terminalPanel.classList.toggle('hidden');
        if (!isHidden) {
          setTimeout(() => termCmdEl.focus(), 0);
        }
      });

      document.getElementById('backBtn').addEventListener('click', () => {
        currentJobId = null;
        jobIdEl.textContent = '—';
        jobFileListEl.innerHTML = '';
        codeEl.value = '';
        openFilePath = null;
        updateEditorMode();
        logsEl.textContent = 'Cleared.';
        statusEl.textContent = 'Ready.';
        chatMessagesEl.innerHTML = '';
        videoEl.removeAttribute('src');
        videoEl.load();
        timelineTrackEl.innerHTML = '';
        timelineState = [];
      });

      openSettingsBtn.addEventListener('click', () => {
        settingsDrawer.classList.toggle('open');
      });
      settingsShowKeyBtn.addEventListener('click', () => {
        const isHidden = settingsApiKeyEl.type === 'password';
        settingsApiKeyEl.type = isHidden ? 'text' : 'password';
      });

      const tabs = Array.from(document.querySelectorAll('.tab'));
      const panels = Array.from(document.querySelectorAll('.tab-panel'));
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const target = tab.dataset.tab;
          panels.forEach(p => p.classList.toggle('active', p.dataset.tab === target));
        });
      });

      function initSplitter(splitter, side) {
        let startX = 0;
        let startLeft = 0;
        let startRight = 0;

        splitter.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startX = e.clientX;
          const sizes = getLayoutSizes();
          startLeft = Number(sizes.left) || 280;
          startRight = Number(sizes.right) || 360;
          const prevUserSelect = document.body.style.userSelect;
          const prevCursor = document.body.style.cursor;
          document.body.style.userSelect = 'none';
          document.body.style.cursor = 'col-resize';

          function onMove(ev) {
            const dx = ev.clientX - startX;
            if (side === 'left') {
              const next = Math.max(220, Math.min(520, startLeft + dx));
              saveLayoutSizes(next, startRight);
            } else {
              const next = Math.max(260, Math.min(560, startRight - dx));
              saveLayoutSizes(startLeft, next);
            }
            applyLayoutColumns();
          }

          function onUp() {
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onUp);
            document.body.style.userSelect = prevUserSelect;
            document.body.style.cursor = prevCursor;
          }

          window.addEventListener('mousemove', onMove);
          window.addEventListener('mouseup', onUp);
        });
      }
      initSplitter(splitterLeft, 'left');
      initSplitter(splitterRight, 'right');
      // Keep layout sane across resizes and avoid "panels disappeared" glitches.
      try {
        mqNarrow.addEventListener('change', applyLayoutColumns);
      } catch {
        try { mqNarrow.addListener(applyLayoutColumns); } catch {}
      }
      window.addEventListener('resize', applyLayoutColumns);

      function setPreviewAspect(ratio) {
        let val = '9 / 16';
        if (ratio === '16:9') val = '16 / 9';
        if (ratio === '1:1') val = '1 / 1';
        previewSlot.style.setProperty('--preview-aspect', val);
      }

      function setStep(step, state) {
        const el = agentStepsEl.querySelector(`[data-step="${step}"]`);
        if (!el) return;
        el.classList.remove('active','done','error');
        if (state) el.classList.add(state);
      }
      function resetSteps() {
        ['plan','approve','code','render'].forEach(s => setStep(s, ''));
      }

      function addChat(role, title, content, extraNode) {
        const bubble = document.createElement('div');
        bubble.className = `bubble ${role}`;
        bubble.innerHTML = `<div class="bubble-title">${title}</div><div>${content}</div>`;
        if (extraNode) bubble.appendChild(extraNode);
        chatMessagesEl.appendChild(bubble);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      }

      function updateJobFiles(files) {
        jobFileListEl.innerHTML = '';
        if (!files || !files.length) {
          jobFileListEl.innerHTML = '<div class="muted">No files yet.</div>';
          return;
        }
        files.forEach(f => {
          const item = document.createElement('div');
          item.className = 'tree-file';
          item.textContent = f;
          jobFileListEl.appendChild(item);
        });
      }

      function renderTree(node, container) {
        if (!node) return;
        if (node.type === 'dir') {
          const details = document.createElement('details');
          details.open = true;
          const summary = document.createElement('summary');
          summary.textContent = node.name || 'folder';
          details.appendChild(summary);
          (node.children || []).forEach(child => renderTree(child, details));
          container.appendChild(details);
        } else {
          const item = document.createElement('div');
          item.className = 'tree-file';
          item.textContent = node.name;
          item.draggable = true;
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', node.path);
            e.dataTransfer.effectAllowed = 'copy';
          });
          item.addEventListener('click', () => openWorkspaceFile(node.path));
          container.appendChild(item);
        }
      }

      function setActiveTab(tabId) {
        const tabs = Array.from(document.querySelectorAll('.tab'));
        const panels = Array.from(document.querySelectorAll('.tab-panel'));
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
        panels.forEach(p => p.classList.toggle('active', p.dataset.tab === tabId));
      }

      function updateEditorMode() {
        if (!openFilePath) {
          editorLabelEl.textContent = 'Editor • generated code';
          saveFileBtn.disabled = true;
          renderCodeBtn.disabled = false;
          addSelectionBtn.disabled = false;
          return;
        }
        editorLabelEl.textContent = `Editor • ${openFilePath}`;
        saveFileBtn.disabled = false;
        const canRender = openFilePath.endsWith('.py');
        renderCodeBtn.disabled = !canRender;
        addSelectionBtn.disabled = false;
      }

      function lineOfIndex(text, idx) {
        if (idx <= 0) return 1;
        let n = 1;
        for (let i = 0; i < idx && i < text.length; i++) {
          if (text[i] === '\\n') n += 1;
        }
        return n;
      }

      function addSelectionToPrompt() {
        const text = codeEl.value || '';
        const a = codeEl.selectionStart ?? 0;
        const b = codeEl.selectionEnd ?? 0;
        if (a === b) {
          statusEl.textContent = 'Select some text in the editor first.';
          return;
        }
        const sel = text.slice(a, b);
        const l1 = lineOfIndex(text, a);
        const l2 = lineOfIndex(text, b);
        const label = openFilePath ? `${openFilePath}:${l1}-${l2}` : `generated_scene.py:${l1}-${l2}`;
        chatInputEl.value += `\n\n[@ref ${label}]\n${sel}\n`;
        statusEl.textContent = `Added selection to prompt: ${label}`;
      }

      addSelectionBtn.addEventListener('click', addSelectionToPrompt);

      let highlightOn = false;
      function refreshHighlight() {
        codePrettyEl.textContent = codeEl.value || '';
        if (window.hljs) {
          try { window.hljs.highlightElement(codePrettyEl); } catch {}
        }
      }
      toggleHighlightBtn.addEventListener('click', () => {
        highlightOn = !highlightOn;
        codePrettyWrapEl.classList.toggle('hidden', !highlightOn);
        codeEl.classList.toggle('hidden', highlightOn);
        toggleHighlightBtn.textContent = highlightOn ? 'Edit' : 'Highlight';
        if (highlightOn) refreshHighlight();
      });
      codeEl.addEventListener('input', () => {
        if (highlightOn) refreshHighlight();
      });
      function setThumb(el, opts) {
        const url = opts?.url || '';
        const type = opts?.type || '';
        const relPath = opts?.relPath || '';
        el.innerHTML = '';
        if (!url) {
          el.textContent = 'No image yet';
          el.classList.remove('draggable');
          el.removeAttribute('draggable');
          return;
        }
        const img = document.createElement('img');
        img.src = url;
        img.alt = type;
        el.appendChild(img);
        el.classList.add('draggable');
        el.draggable = true;
        el.title = `Drag into a scene (${type})`;
        el.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/asset-type', type);
          e.dataTransfer.setData('text/asset-path', relPath);
          e.dataTransfer.effectAllowed = 'copy';
        }, { once: true });
      }

      async function openWorkspaceFile(path) {
        if (!path) return;
        let data = null;
        try {
          const resp = await fetch(`/api/files/file?path=${encodeURIComponent(path)}`);
          data = await resp.json();
        } catch (e) {
          logsEl.textContent = 'Failed to reach backend.';
          return;
        }
        if (!data.ok) {
          logsEl.textContent = data.error || 'Failed to open file.';
          return;
        }
        openFilePath = data.path;
        codeEl.value = data.content || '';
        updateEditorMode();
        setActiveTab('code');
        codeEl.focus();
      }

      async function saveWorkspaceFile() {
        if (!openFilePath) return;
        let data = null;
        try {
          const resp = await fetch('/api/files/file', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: openFilePath, content: codeEl.value })
          });
          data = await resp.json();
        } catch (e) {
          logsEl.textContent = 'Failed to reach backend.';
          return;
        }
        if (!data.ok) {
          logsEl.textContent = data.error || 'Failed to save file.';
          return;
        }
        logsEl.textContent = `Saved: ${openFilePath}`;
        showToast(`Saved: ${openFilePath}`, 'ok');
      }

      function startRename(fromPath) {
        pendingRenameFrom = fromPath;
        newPathEl.value = fromPath;
        newPathEl.focus();
        const lastSlash = fromPath.lastIndexOf('/');
        const dot = fromPath.lastIndexOf('.');
        const selStart = lastSlash >= 0 ? lastSlash + 1 : 0;
        const selEnd = (dot > selStart) ? dot : fromPath.length;
        try {
          newPathEl.setSelectionRange(selStart, selEnd);
        } catch {}
        fileStatusEl.textContent = 'Rename: edit the path above and press Enter.';
        applyRenameBtn.classList.remove('hidden');
      }

      async function renamePending() {
        const toPath = newPathEl.value.trim();
        const fromPath = pendingRenameFrom;
        if (!fromPath) return;
        if (!toPath) {
          fileStatusEl.textContent = 'Rename cancelled: empty path.';
          pendingRenameFrom = null;
          applyRenameBtn.classList.add('hidden');
          return;
        }
        fileStatusEl.textContent = 'Renaming...';
        let data = null;
        try {
          const resp = await fetch('/api/files/rename', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ from_path: fromPath, to_path: toPath })
          });
          data = await resp.json();
        } catch (e) {
          fileStatusEl.textContent = 'Failed to reach backend.';
          return;
        }
        if (!data.ok) {
          fileStatusEl.textContent = data.error || 'Rename failed.';
          return;
        }
        pendingRenameFrom = null;
        applyRenameBtn.classList.add('hidden');
        newPathEl.value = '';
        fileStatusEl.textContent = `Renamed: ${fromPath} → ${toPath}`;
        if (openFilePath === fromPath) {
          openFilePath = toPath;
          updateEditorMode();
        }
        loadWorkspaceFiles();
      }

      async function loadWorkspaceFiles() {
        const resp = await fetch('/api/files');
        const data = await resp.json();
        workspaceTreeEl.innerHTML = '';
        renderTree(data.tree, workspaceTreeEl);
      }

      async function createFolder() {
        const path = newPathEl.value.trim();
        if (!path) {
          // Quick create a default folder, then prompt rename.
          let idx = 0;
          while (idx < 50) {
            const candidate = idx === 0 ? 'New Folder' : `New Folder ${idx + 1}`;
            try {
              const resp = await fetch('/api/files/folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: candidate })
              });
              const data = await resp.json();
              if (data.ok) {
                loadWorkspaceFiles();
                startRename(data.path);
                return;
              }
            } catch (e) {
              fileStatusEl.textContent = 'Failed to reach backend. Is the server running?';
              return;
            }
            idx += 1;
          }
          fileStatusEl.textContent = 'Failed to create a new folder.';
          return;
        }
        fileStatusEl.textContent = 'Creating folder...';
        let data = null;
        try {
          const resp = await fetch('/api/files/folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
          });
          data = await resp.json();
        } catch (e) {
          fileStatusEl.textContent = 'Failed to reach backend. Is the server running?';
          return;
        }
        if (!data.ok) {
          fileStatusEl.textContent = data.error || 'Failed to create folder.';
          return;
        }
        fileStatusEl.textContent = `Folder created: ${data.path}`;
        startRename(data.path);
        loadWorkspaceFiles();
      }

      async function createFile() {
        const path = newPathEl.value.trim();
        if (!path) {
          // Quick create an untitled file, then prompt rename.
          let idx = 0;
          while (idx < 50) {
            const candidate = idx === 0 ? 'untitled.md' : `untitled-${idx + 1}.md`;
            try {
              const resp = await fetch('/api/files/file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: candidate, content: '' })
              });
              const data = await resp.json();
              if (data.ok) {
                loadWorkspaceFiles();
                startRename(data.path);
                await openWorkspaceFile(data.path);
                return;
              }
            } catch (e) {
              fileStatusEl.textContent = 'Failed to reach backend. Is the server running?';
              return;
            }
            idx += 1;
          }
          fileStatusEl.textContent = 'Failed to create a new file.';
          return;
        }
        fileStatusEl.textContent = 'Creating file...';
        let data = null;
        try {
          const resp = await fetch('/api/files/file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path, content: '' })
          });
          data = await resp.json();
        } catch (e) {
          fileStatusEl.textContent = 'Failed to reach backend. Is the server running?';
          return;
        }
        if (!data.ok) {
          fileStatusEl.textContent = data.error || 'Failed to create file.';
          return;
        }
        fileStatusEl.textContent = `File created: ${data.path}`;
        startRename(data.path);
        loadWorkspaceFiles();
        await openWorkspaceFile(data.path);
      }

      chatInputEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        chatInputEl.classList.add('drop-target');
      });
      chatInputEl.addEventListener('dragleave', () => {
        chatInputEl.classList.remove('drop-target');
      });
      chatInputEl.addEventListener('drop', async (e) => {
        e.preventDefault();
        chatInputEl.classList.remove('drop-target');
        const path = e.dataTransfer.getData('text/plain');
        if (!path) return;
        const resp = await fetch(`/api/files/file?path=${encodeURIComponent(path)}`);
        const data = await resp.json();
        if (!data.ok) {
          statusEl.textContent = data.error || 'Failed to attach file.';
          return;
        }
        chatInputEl.value += `\n\n[File: ${data.path}]\n${data.content}\n`;
      });

      async function loadTemplates() {
        const resp = await fetch('/api/templates');
        const data = await resp.json();
        templates = data.templates || [];
        templateSelectEl.innerHTML = '';
        templates.forEach((t, idx) => {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = `${t.name} (${t.category})`;
          if (idx === 0) opt.selected = true;
          templateSelectEl.appendChild(opt);
        });
        if (templates[0]) applyTemplate(templates[0]);
      }

      function applyTemplate(tpl) {
        if (!tpl) return;
        templateDescriptionEl.value = tpl.description;
        if (tpl.example_prompt) chatInputEl.value = tpl.example_prompt;
        if (tpl.director_brief) directorBriefEl.value = tpl.director_brief;
        const d = tpl.defaults || {};
        if (d.audience) audienceEl.value = d.audience;
        if (d.tone) toneEl.value = d.tone;
        if (d.style) styleEl.value = d.style;
        if (d.pace) paceEl.value = d.pace;
        if (d.color_palette) paletteEl.value = d.color_palette;
        if (d.aspect_ratio) { aspectEl.value = d.aspect_ratio; setPreviewAspect(d.aspect_ratio); }
        if (d.quality) qualityEl.value = d.quality;
        if (typeof d.include_equations === 'boolean') equationsEl.value = d.include_equations ? 'true' : 'false';
        if (typeof d.include_graphs === 'boolean') graphsEl.value = d.include_graphs ? 'true' : 'false';
        if (typeof d.include_narration === 'boolean') narrationEl.value = d.include_narration ? 'true' : 'false';
        if (d.target_seconds) targetSecondsEl.value = d.target_seconds;
      }

      templateSelectEl.addEventListener('change', () => {
        const tpl = templates.find(t => t.id === templateSelectEl.value);
        applyTemplate(tpl);
      });

      async function loadSettings() {
        const resp = await fetch('/api/settings');
        const data = await resp.json();
        if (data.text_model) {
          settingsTextModelEl.value = data.text_model;
          chatModelEl.value = data.text_model;
        }
        if (data.image_model) settingsImageModelEl.value = data.image_model;
        if (data.manim_py) settingsManimPyEl.value = data.manim_py;
        if (!data.has_api_key) {
          statusEl.textContent = 'Hackathon tip: open Settings and paste your Gemini API key.';
          try {
            const seen = localStorage.getItem('seenApiKeyHint');
            if (!seen) {
              settingsDrawer.classList.add('open');
              localStorage.setItem('seenApiKeyHint', '1');
            }
          } catch {}
        }
      }

      async function saveSettings() {
        const resp = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            api_key: settingsApiKeyEl.value || null,
            text_model: settingsTextModelEl.value || null,
            image_model: settingsImageModelEl.value || null,
            manim_py: settingsManimPyEl.value || null
          })
        });
        const data = await resp.json();
        if (data.ok) {
          statusEl.textContent = 'Settings saved.';
          settingsApiKeyEl.value = '';
          if (data.text_model) chatModelEl.value = data.text_model;
        }
      }

      async function runHealth() {
        healthEl.textContent = 'Checking...';
        let data = null;
        try {
          const resp = await fetch('/api/health');
          data = await resp.json();
        } catch (e) {
          healthEl.textContent = 'Failed to reach backend. Is the server running?';
          return;
        }
        const manimStatus = data.manim_ok ? 'OK' : 'Missing';
        const ffmpegStatus = data.ffmpeg_ok ? 'OK' : 'Missing';
        const py = data.manim_py || 'python3';
        const cands = (data.python_candidates || []).join(', ');
        const ffmpegPath = data.ffmpeg_path || '';
        const lines = [
          `Manim: ${manimStatus}`,
          `ffmpeg: ${ffmpegStatus}`,
          `python: ${py}`,
        ];
        if (data.manim_version) lines.push(data.manim_version);
        if (cands) lines.push(`python candidates: ${cands}`);
        if (ffmpegPath) lines.push(`ffmpeg path: ${ffmpegPath}`);
        if (!data.manim_ok) lines.push('Fix: set "Python executable for Manim" to an env with Manim installed.');
        if (!data.ffmpeg_ok) lines.push('Fix (macOS): brew install ffmpeg');
        healthEl.textContent = lines.join('\n');
      }

      async function loadMemories() {
        const resp = await fetch('/api/memories');
        const data = await resp.json();
        memoryListEl.innerHTML = '';
        (data.memories || []).forEach(mem => {
          const row = document.createElement('div');
          row.className = 'tree-file';
          row.innerHTML = `<label><input type="checkbox" data-id="${mem.id}" /> ${mem.title}</label>`;
          memoryListEl.appendChild(row);
        });
      }

      async function addMemory() {
        await fetch('/api/memories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: memoryTitleEl.value, content: memoryContentEl.value })
        });
        memoryTitleEl.value = '';
        memoryContentEl.value = '';
        loadMemories();
      }

      function selectedMemoryIds() {
        return Array.from(memoryListEl.querySelectorAll('input[type="checkbox"]')).filter(cb => cb.checked).map(cb => cb.dataset.id);
      }

      async function loadSkills() {
        const resp = await fetch('/api/skills');
        const data = await resp.json();
        skillListEl.innerHTML = '';
        (data.skills || []).forEach(skill => {
          const row = document.createElement('div');
          row.className = 'tree-file';
          row.innerHTML = `<label><input type="checkbox" data-id="${skill.id}" /> ${skill.name}</label>`;
          skillListEl.appendChild(row);
        });
      }

      async function saveSkill() {
        await fetch('/api/skills', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: skillNameEl.value, content: skillContentEl.value })
        });
        skillNameEl.value = '';
        skillContentEl.value = '';
        loadSkills();
      }

      async function generateSkill() {
        await fetch('/api/skills/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idea: skillIdeaEl.value, name: skillGenerateNameEl.value })
        });
        skillIdeaEl.value = '';
        skillGenerateNameEl.value = '';
        loadSkills();
      }

      function selectedSkillIds() {
        return Array.from(skillListEl.querySelectorAll('input[type="checkbox"]')).filter(cb => cb.checked).map(cb => cb.dataset.id);
      }

      function renderTimelineRuler(totalSeconds) {
        if (!timelineRulerEl) return;
        timelineRulerEl.innerHTML = '';
        const total = Math.max(1, Math.floor(Number(totalSeconds || 1)));

        let minor = 1;
        let major = 5;
        if (total > 30 && total <= 120) { minor = 5; major = 10; }
        else if (total > 120 && total <= 300) { minor = 10; major = 30; }
        else if (total > 300) { minor = 30; major = 60; }

        function addTick(t, isMajor) {
          const pct = (t / total) * 100;
          const tick = document.createElement('div');
          tick.className = 'tick' + (isMajor ? ' major' : '');
          tick.style.left = `${pct}%`;
          timelineRulerEl.appendChild(tick);
          if (isMajor) {
            const label = document.createElement('div');
            label.className = 'tick-label';
            label.style.left = `${pct}%`;
            label.textContent = `${t}s`;
            timelineRulerEl.appendChild(label);
          }
        }

        for (let t = 0; t <= total; t += minor) {
          addTick(t, t % major === 0);
        }
        if (total % minor !== 0) addTick(total, true);
      }

      function renderTimeline() {
        timelineTrackEl.innerHTML = '';
        if (!timelineState.length) {
          timelineLabelEl.textContent = 'Timeline';
          if (timelineRulerEl) timelineRulerEl.innerHTML = '';
          return;
        }
        const total = timelineState.reduce((s, sc) => s + sc.seconds, 0);
        timelineLabelEl.textContent = `Total ${total}s • ${timelineState.length} scenes`;
        renderTimelineRuler(total);

        let cursor = 0;
        timelineState.forEach((scene, idx) => {
          const start = cursor;
          const end = start + Number(scene.seconds || 0);
          cursor = end;
          const block = document.createElement('div');
          block.className = 'timeline-block';
          block.draggable = true;
          block.dataset.index = idx;
          block.style.flex = String(scene.seconds);

          const header = document.createElement('div');
          header.className = 'timeline-block-header';
          header.textContent = `${idx + 1}. ${start}s–${end}s • ${(scene.goal || 'Scene').slice(0, 36)}`;

          const assetLine = document.createElement('div');
          assetLine.className = 'muted';
          const bg = scene.assets?.background ? 'BG' : '';
          const fg = scene.assets?.foreground ? 'FG' : '';
          assetLine.textContent = (bg || fg) ? `Assets: ${[bg, fg].filter(Boolean).join(' + ')}` : 'Assets: (drop BG/FG)';

          const input = document.createElement('input');
          input.type = 'number';
          input.min = 1;
          input.value = scene.seconds;
          input.title = 'Scene seconds';
          input.addEventListener('change', () => {
            const val = Math.max(1, Number(input.value || 1));
            timelineState[idx].seconds = val;
            renderTimeline();
          });

          block.appendChild(header);
          block.appendChild(assetLine);
          block.appendChild(input);

          block.addEventListener('dragstart', (e) => {
            block.classList.add('dragging');
            e.dataTransfer.setData('text/plain', idx.toString());
          });
          block.addEventListener('dragend', () => {
            block.classList.remove('dragging');
          });
          block.addEventListener('dragover', (e) => {
            e.preventDefault();
          });
          block.addEventListener('drop', (e) => {
            e.preventDefault();
            const assetType = e.dataTransfer.getData('text/asset-type');
            const assetPath = e.dataTransfer.getData('text/asset-path');
            if (assetType && assetPath) {
              const to = Number(block.dataset.index);
              const sc = timelineState[to];
              sc.assets = sc.assets || {};
              sc.assets[assetType] = assetPath;
              renderTimeline();
              return;
            }

            const from = Number(e.dataTransfer.getData('text/plain'));
            const to = Number(block.dataset.index);
            if (Number.isNaN(from) || Number.isNaN(to) || from === to) return;
            const moved = timelineState.splice(from, 1)[0];
            timelineState.splice(to, 0, moved);
            renderTimeline();
          });

          timelineTrackEl.appendChild(block);
        });
      }

      function syncPlanFromTimeline() {
        if (!lastPlanBox || !timelineState.length) return;
        const total = timelineState.reduce((s, sc) => s + sc.seconds, 0);
        const plan = {
          title: timelineMeta.title || 'Scene Plan',
          total_seconds: total,
          scenes: timelineState.map((sc) => ({
            seconds: sc.seconds,
            goal: sc.goal || 'Updated scene',
            elements: sc.elements || [],
            actions: sc.actions || [],
            narration: sc.narration || '',
            assets: sc.assets || {}
          }))
        };
        lastPlanBox.value = JSON.stringify(plan, null, 2);
        currentPlanText = lastPlanBox.value;
      }

      function buildDirectorBrief() {
        const pieces = [];
        if (directorBriefEl.value.trim()) pieces.push(directorBriefEl.value.trim());
        const rules = rulesTextEl.value.trim();
        if (rules) pieces.push(`Rules:\n${rules}`);
        const sub = subagentsTextEl.value.trim();
        if (sub) pieces.push(`Subagents:\n${sub}`);

        const sources = getSources();
        if (sources.length) {
          const block = sources.map((s, i) => `Source ${i + 1}: ${s.url || '(no url)'}\n${s.notes || ''}`.trim()).join('\n\n');
          pieces.push(`References:\n${block}`);
        }
        return pieces.join('\n\n') || null;
      }

      async function runSlashCommand(text) {
        const raw = text.trim();
        if (!raw.startsWith('/')) return false;
        const parts = raw.split(/\s+/g);
        const cmd = parts[0].toLowerCase();
        if (cmd === '/health') {
          settingsDrawer.classList.add('open');
          await runHealth();
          return true;
        }
        if (cmd === '/settings') {
          settingsDrawer.classList.toggle('open');
          return true;
        }
        if (cmd === '/clear') {
          document.getElementById('backBtn').click();
          return true;
        }
        if (cmd === '/attach') {
          const path = parts.slice(1).join(' ');
          if (!path) {
            statusEl.textContent = 'Usage: /attach notes/outline.md';
            return true;
          }
          const resp = await fetch(`/api/files/file?path=${encodeURIComponent(path)}`);
          const data = await resp.json();
          if (!data.ok) {
            statusEl.textContent = data.error || 'Attach failed.';
            return true;
          }
          chatInputEl.value = `Attached file: ${data.path}\n\n${data.content}\n\n`;
          return true;
        }
        statusEl.textContent = `Unknown command: ${cmd}`;
        return true;
      }

      async function createPlan() {
        resetSteps();
        setStep('plan', 'active');

        const idea = chatInputEl.value.trim();
        if (!idea) return;

        if (await runSlashCommand(idea)) return;

        addChat('user', 'You', idea);
        statusEl.textContent = 'Planning...';

        const resp = await fetch('/api/plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            idea,
            audience: audienceEl.value,
            tone: toneEl.value,
            style: styleEl.value,
            pace: paceEl.value,
            color_palette: paletteEl.value,
            include_equations: equationsEl.value === 'true',
            include_graphs: graphsEl.value === 'true',
            include_narration: narrationEl.value === 'true',
            target_seconds: targetSecondsEl.value ? Number(targetSecondsEl.value) : null,
            max_scenes: maxScenesEl.value ? Number(maxScenesEl.value) : null,
            max_objects: maxObjectsEl.value ? Number(maxObjectsEl.value) : null,
            aspect_ratio: aspectEl.value,
            director_brief: buildDirectorBrief(),
            include_images: includeImagesEl.value === 'true',
            image_prompt: imagePromptEl.value || null,
            memory_ids: selectedMemoryIds(),
            skill_ids: selectedSkillIds(),
            model: chatModelEl.value || null
          })
        });
        const data = await resp.json();
        if (!data.ok) {
          statusEl.textContent = data.error || 'Plan failed.';
          showToast(data.error || 'Plan failed.', 'err');
          setStep('plan', 'error');
          return;
        }
        currentJobId = data.job_id;
        currentPlanText = data.plan_text;
        jobIdEl.textContent = currentJobId;
        updateJobFiles(data.job_files);

        const planBox = document.createElement('textarea');
        planBox.style.width = '100%';
        planBox.style.minHeight = '180px';
        planBox.value = data.plan_text;
        lastPlanBox = planBox;

        const approveBtn = document.createElement('button');
        approveBtn.textContent = 'Approve & Render';
        approveBtn.style.marginTop = '8px';

        const wrapper = document.createElement('div');
        wrapper.appendChild(planBox);
        wrapper.appendChild(approveBtn);

        addChat('agent', 'Scene Plan (edit if needed)', '', wrapper);
        setStep('plan', 'done');
        setStep('approve', 'active');

        approveBtn.addEventListener('click', async () => {
          await approvePlan(planBox.value);
        });

        if (data.plan && data.plan.scenes) {
          timelineMeta.title = data.plan.title || 'Scene Plan';
          timelineState = data.plan.scenes.map(sc => ({
            seconds: sc.seconds || 3,
            goal: sc.goal,
            elements: sc.elements,
            actions: sc.actions,
            narration: sc.narration
          }));
          renderTimeline();
        }
      }

      async function approvePlan(planText) {
        if (!currentJobId) return;
        statusEl.textContent = 'Generating video...';
        setStep('approve', 'done');
        setStep('code', 'active');

        const resp = await fetch('/api/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            job_id: currentJobId,
            plan_text: planText,
            include_images: includeImagesEl.value === 'true',
            image_prompt: imagePromptEl.value || null,
            image_mode: imageModeEl.value,
            image_model: imageModelOverrideEl.value || null,
            quality: qualityEl.value,
            aspect_ratio: aspectEl.value,
            model: chatModelEl.value || null
          })
        });
        const data = await resp.json();
        if (!data.ok) {
          statusEl.textContent = data.error || 'Render failed.';
          showToast(data.error || 'Render failed.', 'err');
          setStep('code', 'error');
          setStep('render', 'error');
          logsEl.textContent = data.logs || data.error || 'Render failed.';
          return;
        }
        setStep('code', 'done');
        setStep('render', 'done');

        const src = '/' + data.video_path + '?t=' + Date.now();
        lastVideoUrl = src;
        videoEl.src = src;
        videoEl.load();
        codeEl.value = data.code || '';
        openFilePath = null;
        updateEditorMode();
        updateJobFiles(data.job_files);
        logsEl.textContent = data.image_warning ? data.image_warning : (data.logs || 'Render complete.');
        showToast('Render complete.', 'ok');

        // Asset thumbnails (job-level background/foreground)
        lastAssets = { background: '', foreground: '' };
        if (data.assets && (data.assets.background || data.assets.foreground)) {
          if (data.assets.background) {
            const url = `/work/jobs/${data.job_id}/${data.assets.background}?t=${Date.now()}`;
            lastAssets.background = data.assets.background;
            setThumb(bgThumbEl, { url, type: 'background', relPath: data.assets.background });
          } else {
            setThumb(bgThumbEl, { url: '', type: 'background', relPath: '' });
          }
          if (data.assets.foreground) {
            const url = `/work/jobs/${data.job_id}/${data.assets.foreground}?t=${Date.now()}`;
            lastAssets.foreground = data.assets.foreground;
            setThumb(fgThumbEl, { url, type: 'foreground', relPath: data.assets.foreground });
          } else {
            setThumb(fgThumbEl, { url: '', type: 'foreground', relPath: '' });
          }
        } else {
          setThumb(bgThumbEl, { url: '', type: 'background', relPath: '' });
          setThumb(fgThumbEl, { url: '', type: 'foreground', relPath: '' });
        }

        if (data.plan && data.plan.scenes) {
          timelineMeta.title = data.plan.title || 'Scene Plan';
          timelineState = data.plan.scenes.map(sc => ({
            seconds: sc.seconds || 3,
            goal: sc.goal,
            elements: sc.elements,
            actions: sc.actions,
            narration: sc.narration,
            assets: sc.assets || {}
          }));
          renderTimeline();
        }

        addChat('agent', 'Render complete', `<a href="${src}" target="_blank">Open video</a>`);
      }

      renderCodeBtn.addEventListener('click', async () => {
        if (!codeEl.value.trim()) return;
        if (openFilePath && !openFilePath.endsWith('.py')) {
          statusEl.textContent = 'Render disabled: you are editing a non-Python workspace file.';
          return;
        }
        const resp = await fetch('/api/render-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: codeEl.value, quality: qualityEl.value })
        });
        const data = await resp.json();
        if (!data.ok) {
          statusEl.textContent = data.error || 'Render failed.';
          showToast(data.error || 'Render failed.', 'err');
          logsEl.textContent = data.logs || data.error || 'Render failed.';
          return;
        }
        const src = '/' + data.video_path + '?t=' + Date.now();
        lastVideoUrl = src;
        videoEl.src = src;
        videoEl.load();
        openFilePath = null;
        updateEditorMode();
        updateJobFiles(data.job_files);
        logsEl.textContent = data.logs || 'Render complete.';
        showToast('Render complete.', 'ok');
      });

      downloadVideoBtn.addEventListener('click', () => {
        if (!videoEl.src) return;
        const a = document.createElement('a');
        a.href = videoEl.src;
        a.download = currentJobId ? `${currentJobId}.mp4` : 'out.mp4';
        document.body.appendChild(a);
        a.click();
        a.remove();
        showToast('Downloading video…', 'ok');
      });

      async function runTerminalCommand() {
        const cmd = (termCmdEl.value || '').trim();
        if (!cmd) return;
        termRunEl.disabled = true;
        logsEl.textContent = `> ${cmd}\n`;
        try {
          const resp = await fetch('/api/terminal/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: cmd })
          });
          const data = await resp.json();
          if (!data.ok) {
            logsEl.textContent += (data.error || 'Command failed') + '\n';
            return;
          }
          logsEl.textContent += (data.output || '') + '\n';
        } catch (e) {
          logsEl.textContent += 'Failed to reach backend.\n';
        } finally {
          termRunEl.disabled = false;
        }
      }
      termRunEl.addEventListener('click', runTerminalCommand);
      termCmdEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          runTerminalCommand();
        }
      });

      timelineScrubEl.addEventListener('input', () => {
        if (!videoEl.duration) return;
        const pct = Number(timelineScrubEl.value) / 100;
        videoEl.currentTime = pct * videoEl.duration;
      });
      videoEl.addEventListener('timeupdate', () => {
        if (!videoEl.duration) return;
        timelineScrubEl.value = Math.floor((videoEl.currentTime / videoEl.duration) * 100);
      });

      applyTimelineBtn.addEventListener('click', syncPlanFromTimeline);
      resetTimelineBtn.addEventListener('click', () => {
        timelineState = [];
        renderTimeline();
      });

      planBtn.addEventListener('click', createPlan);
      saveSettingsBtn.addEventListener('click', saveSettings);
      runHealthBtn.addEventListener('click', runHealth);
      resetLayoutBtn.addEventListener('click', resetLayout);
      addMemoryBtn.addEventListener('click', addMemory);
      saveSkillBtn.addEventListener('click', saveSkill);
      generateSkillBtn.addEventListener('click', generateSkill);
      aspectEl.addEventListener('change', () => setPreviewAspect(aspectEl.value));
      applyRenameBtn.addEventListener('click', renamePending);
      createFolderBtn.addEventListener('click', createFolder);
      createFileBtn.addEventListener('click', createFile);
      newPathEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && pendingRenameFrom) {
          e.preventDefault();
          renamePending();
        }
      });

      saveFileBtn.addEventListener('click', saveWorkspaceFile);
      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
          if (openFilePath) {
            e.preventDefault();
            saveWorkspaceFile();
          }
        }
      });

      saveSourceBtn.addEventListener('click', () => {
        const url = sourceUrlEl.value.trim();
        const notes = sourceNotesEl.value.trim();
        const sources = getSources();
        sources.unshift({ url, notes, saved_at: new Date().toISOString() });
        setSources(sources.slice(0, 10));
        renderSources();
        sourceUrlEl.value = '';
        sourceNotesEl.value = '';
      });

      function seedDemoDefaults() {
        // Keep this lightweight: only fill if the user hasn't typed anything.
        if (!chatInputEl.value.trim()) {
          chatInputEl.value = 'Explain the photoelectric effect in 60 seconds (red vs blue light, threshold frequency, Einstein equation).';
        }
        if (!imagePromptEl.value.trim()) {
          imagePromptEl.value = 'Scientist walking in a park at sunrise';
        }
        if (!includeImagesEl.value) includeImagesEl.value = 'true';
        if (!imageModeEl.value) imageModeEl.value = 'background';

        if (!aspectEl.value) aspectEl.value = '9:16';
        if (!audienceEl.value) audienceEl.value = 'high school';
        if (!toneEl.value) toneEl.value = 'epic';
        if (!styleEl.value) styleEl.value = 'cinematic';
        if (!paceEl.value) paceEl.value = 'medium';
        if (!paletteEl.value) paletteEl.value = 'cool';
        if (!qualityEl.value) qualityEl.value = 'pqm';
        if (!targetSecondsEl.value.trim()) targetSecondsEl.value = '60';
        if (!maxScenesEl.value.trim()) maxScenesEl.value = '6';

        if (!rulesTextEl.value.trim()) {
          rulesTextEl.value = [
            'Show 1 concept at a time.',
            'Keep all text centered with safe padding for 9:16.',
            'Always label variables when introduced; avoid clutter.',
            'Use simple arrows/axes; avoid tiny text.',
          ].join('\\n');
        }
        if (!subagentsTextEl.value.trim()) {
          subagentsTextEl.value = [
            'Director: write a tight storyboard + timings.',
            'Animator: convert storyboard to Manim, centered layout, clean labels.',
            'QA: check overlaps, padding, and whether the story is intuitive.',
          ].join('\\n');
        }

        try {
          const sources = getSources();
          if (!sources.length) {
            setSources([{
              url: 'https://example.com/photoelectric-effect',
              notes: 'Key points to include:\\n- Intensity changes number of emitted electrons (when above threshold).\\n- Frequency must exceed threshold: f > f0 (work function).\\n- Einstein: K_max = h f - ϕ.\\n- Stopping potential: e V_s = K_max.',
              saved_at: new Date().toISOString()
            }]);
            renderSources();
          }
        } catch {}

        if (termCmdEl && !termCmdEl.value.trim()) termCmdEl.value = 'help';
        setPreviewAspect(aspectEl.value);
      }

      // Boot
      loadTemplates();
      loadSettings();
      loadMemories();
      loadSkills();
      loadWorkspaceFiles();
      renderSources();
      setPreviewAspect(aspectEl.value);
      updateEditorMode();
      applyLayoutColumns();
      seedDemoDefaults();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
  </body>
</html>
